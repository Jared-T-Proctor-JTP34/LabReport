<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Pharmacy Compounding Compliance Log - Professional USP Monitoring</title>

<!-- Favicon to prevent 404 error -->
<link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üß™</text></svg>">

<!--
BACKEND INTEGRATION - NO USER AUTHENTICATION REQUIRED
‚úÖ Automatic Google Drive uploads via backend service
‚úÖ No user authentication prompts
‚úÖ Seamless operation
‚úÖ Fallback to local download if backend unavailable
-->

<style>
body { 
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
  font-weight: 600; 
  background: #f4f6f9; 
  margin: 20px; 
}
h1, h2 { 
  color: #2c3e50; 
  font-weight: 700; 
}
section { 
  background: #fff; 
  padding: 20px; 
  margin-bottom: 20px; 
  border-radius: 8px; 
  box-shadow: 0 2px 4px rgba(0,0,0,0.1); 
}
label { 
  display: block; 
  margin-top: 10px; 
  font-weight: 600; 
}
input, select, button { 
  padding: 10px; 
  margin-top: 5px; 
  width: 100%; 
  max-width: 300px; 
  font-family: inherit; 
  font-weight: 500; 
  border-radius: 6px; 
  border: 1px solid #ddd;
}
button { 
  background: #3498db; 
  color: white; 
  border: none; 
  cursor: pointer; 
  font-weight: 600; 
  max-width: none;
}
button:hover { 
  background: #2980b9; 
}
.alert { 
  color: red; 
  font-weight: bold; 
}
table { 
  width: 100%; 
  border-collapse: collapse; 
  margin-top: 15px; 
}
th, td { 
  border: 1px solid #ccc; 
  padding: 10px; 
}
th { 
  background: #ecf0f1; 
  font-weight: 700; 
}
.out { 
  background: #ffe6e6; 
}

/* System Status */
.system-status {
  background: #e8f4fd;
  padding: 15px;
  border-radius: 8px;
  margin: 10px 0;
  border-left: 4px solid #4285f4;
}
.system-status.connected {
  background: #d4edda;
  border-left-color: #28a745;
  color: #155724;
}
.system-status.warning {
  background: #fff3cd;
  border-left-color: #ffc107;
  color: #856404;
}
.system-status.error {
  background: #f8d7da;
  border-left-color: #dc3545;
  color: #721c24;
}

/* Tab Styles */
.tab-nav { 
  display: flex; 
  background: #fff; 
  border-radius: 6px 6px 0 0; 
  box-shadow: 0 2px 4px rgba(0,0,0,0.1); 
  margin-top: 20px;
}
.tab-button { 
  flex: 1; 
  padding: 15px 20px; 
  border: none; 
  cursor: pointer; 
  font-size: 14px; 
  font-weight: bold;
  border-right: 1px solid #bdc3c7;
  max-width: none;
  width: auto;
}
.tab-button:last-child { 
  border-right: none; 
}
.tab-button.active { 
  background: #3498db; 
  color: white; 
}
.tab-button:hover:not(.active) { 
  background: #d5dbdb; 
}

.tab-button.non-sterile { 
  background: #2ecc71; 
  color: white; 
}
.tab-button.non-sterile.active { 
  background: #27ae60; 
}

.tab-button.sterile { 
  background: #3498db; 
  color: white; 
}
.tab-button.sterile.active { 
  background: #2980b9; 
}

.tab-button.hazardous { 
  background: #e74c3c; 
  color: white; 
}
.tab-button.hazardous.active { 
  background: #c0392b; 
}

.tab-content { 
  display: none; 
  background: #fff;
  padding: 20px;
  border-radius: 0 0 6px 6px;
  box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}
.tab-content.active { 
  display: block; 
}

.status-indicator {
  padding: 8px;
  margin: 10px 0;
  border-radius: 4px;
  font-weight: 600;
  text-align: center;
}
.status-compliant {
  background: #d4edda;
  color: #155724;
}
.status-non-compliant {
  background: #f8d7da;
  color: #721c24;
}
.status-pending {
  background: #fff3cd;
  color: #856404;
}

/* Custom checkbox styling */
.cleaning-checkbox {
  width: 20px !important;
  height: 20px !important;
  margin-right: 12px !important;
  cursor: pointer;
  accent-color: #3498db;
}

.cleaning-label {
  display: flex;
  align-items: center;
  margin: 2px 0;
  font-size: 14px;
  font-weight: 600;
  cursor: pointer;
  padding: 4px 8px;
  border-radius: 6px;
  transition: background-color 0.2s;
}

.cleaning-label:hover {
  background-color: #f8f9fa;
}

/* History section styling */
.history-section {
  margin-top: 30px;
  border: 1px solid #dee2e6;
  border-radius: 8px;
  overflow: hidden;
}

.history-header {
  background: #f8f9fa;
  padding: 15px 20px;
  cursor: pointer;
  border-bottom: 1px solid #dee2e6;
  display: flex;
  justify-content: space-between;
  align-items: center;
  transition: background-color 0.2s;
}

.history-header:hover {
  background: #e9ecef;
}

.history-header h3 {
  margin: 0;
  font-size: 16px;
  color: #495057;
}

.history-toggle {
  font-size: 18px;
  color: #6c757d;
  transition: transform 0.2s;
}

.history-toggle.expanded {
  transform: rotate(180deg);
}

.history-content {
  display: none;
  padding: 20px;
  background: white;
}

.history-content.show {
  display: block;
}

.history-stats {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
  gap: 15px;
  margin-bottom: 20px;
  padding: 15px;
  background: #f8f9fa;
  border-radius: 6px;
}

.history-stat {
  text-align: center;
}

.history-stat .number {
  font-size: 24px;
  font-weight: 700;
  color: #495057;
  display: block;
}

.history-stat .label {
  font-size: 12px;
  color: #6c757d;
  text-transform: uppercase;
  font-weight: 600;
}
</style>
</head>

<body>

<!-- Status Message Area -->
<div id="statusMessage" style="display:none;position:fixed;top:20px;right:20px;padding:15px 20px;border-radius:8px;font-weight:600;z-index:1000;max-width:400px;box-shadow:0 4px 12px rgba(0,0,0,0.15);"></div>

<!-- Login Screen -->
<div id="loginScreen" style="max-width:500px;margin:60px auto;padding:30px;background:#fff;border-radius:12px;box-shadow:0 4px 12px rgba(0,0,0,0.15)">
  <div style="text-align:center;margin-bottom:25px;">
    <h2 style="color:#2c3e50;margin-bottom:10px;">üß™ Pharmacy Compounding Compliance Log</h2>
    <p style="color:#7f8c8d;font-size:14px;margin:0;">Professional USP Compliance Monitoring System</p>
  </div>
  
  <!-- App Description for Google Compliance -->
  <div style="background:#f8f9fa;padding:20px;border-radius:8px;margin:20px 0;border-left:4px solid #3498db;">
    <h4 style="margin:0 0 10px 0;color:#2c3e50;font-size:16px;">üìã Pharmacy Compounding Compliance Log</h4>
    <p style="margin:0 0 10px 0;font-size:13px;line-height:1.4;color:#495057;">
      Professional USP compliance monitoring system for pharmacy compounding operations. This application helps pharmacy professionals monitor and document compliance with USP (United States Pharmacopeia) standards for compounding areas 795, 797, and 800.
    </p>
    <p style="margin:0 0 10px 0;font-size:13px;line-height:1.4;color:#495057;">
      <strong>Features:</strong> Real-time environmental monitoring (temperature, humidity, air pressure), automated PDF report generation, secure Google Drive integration, cleaning task tracking, and compliance validation against USP standards.
    </p>
    <p style="margin:0;font-size:13px;line-height:1.4;color:#495057;">
      <strong>Data Usage:</strong> The application generates PDF compliance reports and uploads them to your Google Drive for secure storage and regulatory documentation. No personal health information is collected or stored.
    </p>
  </div>
  
  <!-- Google Drive Integration Notice -->
  <div style="background:#e8f5e8;padding:15px;border-radius:6px;margin:15px 0;border-left:4px solid #27ae60;">
    <h5 style="margin:0 0 8px 0;color:#27ae60;font-size:14px;">‚òÅÔ∏è Google Drive Integration</h5>
    <p style="margin:0;font-size:12px;line-height:1.3;color:#2d5a2d;">
      This application will request permission to upload compliance reports to your Google Drive. Reports are saved as PDF files with names like "Labreport - MM-DD-YYYY.pdf" for easy organization and regulatory review.
    </p>
  </div>
  
  <!-- Demo Credentials -->
  <div style="background:#fff3cd;padding:15px;border-radius:6px;margin:15px 0;border-left:4px solid #ffc107;">
    <h5 style="margin:0 0 8px 0;color:#856404;font-size:14px;">üîë Demo Access Credentials</h5>
    <div style="font-family:monospace;font-size:12px;color:#856404;">
      <strong>Administrator:</strong> admin / pharmacy123<br>
      <strong>Pharmacist:</strong> pharmacist / compound456<br>
      <strong>Technician:</strong> tech / sterile789
    </div>
  </div>
  
  <!-- Login Form -->
  <div style="margin-top:25px;">
    <label style="font-weight:600;color:#2c3e50;">Username</label>
    <input type="text" id="loginUser" onkeypress="window.handleLoginKeyPress(event)" style="margin-bottom:15px;">
    
    <label style="font-weight:600;color:#2c3e50;">Password</label>
    <input type="password" id="loginPass" onkeypress="window.handleLoginKeyPress(event)" style="margin-bottom:20px;">
    
    <button onclick="window.login()" style="background:#3498db;padding:12px 20px;font-size:16px;font-weight:600;">
      üöÄ Access Compliance System
    </button>
  </div>
  
  <!-- Error Message -->
  <p id="loginError" class="alert" style="display:none;margin-top:15px;padding:10px;background:#f8d7da;color:#721c24;border-radius:4px;font-size:14px;">Invalid credentials</p>
  
  <!-- Footer Information -->
  <div style="margin-top:25px;padding-top:20px;border-top:1px solid #dee2e6;text-align:center;">
    <p style="margin:0;font-size:11px;color:#6c757d;">
      üè• Professional pharmacy compliance monitoring<br>
      üìä USP 795, 797, 800 standards compliance<br>
      üîí Secure Google Drive integration for report storage
    </p>
  </div>
</div>

<!-- Main App -->
<div id="app" style="display:none">

<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;padding:15px 0;border-bottom:2px solid #ecf0f1;">
  <h1 style="margin:0;">Pharmacy Compounding Compliance Log</h1>
  <div>
    <button onclick="window.logout()" style="background:#e74c3c;padding:10px 20px;">Logout</button>
  </div>
</div>

<!-- System Status with Render Cloud Integration -->
<div id="systemStatus" class="system-status">
  <div style="display:flex;align-items:center;gap:10px;">
    <div id="statusSymbol" style="font-size:24px;" title="Render Cloud Backend with Google Drive Integration">üîÑ</div>
    <div>
      <strong>System Status:</strong> <span id="systemStatusText">Initializing...</span>
      <div id="systemDetails" style="font-size:12px;margin-top:2px;">Connecting to Render cloud backend...</div>
    </div>
  </div>
  <div style="font-size:11px;margin-top:8px;padding:8px;background:rgba(255,255,255,0.3);border-radius:4px;">
    <strong>‚òÅÔ∏è Render Cloud Integration:</strong> Reports automatically upload to <strong>labreporting1177@gmail.com</strong> Google Drive via secure cloud backend
    <div style="margin-top:4px;opacity:0.8;">
      <strong>üåç Environment:</strong> <span id="environmentInfo">Detecting...</span> | 
      <strong>üöÄ Backend:</strong> <span id="backendInfo">labreport-q96c.onrender.com</span>
    </div>
  </div>
</div>

<!-- Tabbed Interface -->
<div class="tab-nav">
  <button class="tab-button non-sterile active" onclick="window.switchTab('non-sterile')">üß™ Non-Sterile (&lt;795&gt;)</button>
  <button class="tab-button sterile" onclick="window.switchTab('sterile')">üî¨ Sterile (&lt;797&gt;)</button>
  <button class="tab-button hazardous" onclick="window.switchTab('hazardous')">‚ö†Ô∏è Hazardous (&lt;800&gt;)</button>
</div>

<!-- Non-Sterile USP <795> Tab -->
<div id="non-sterile" class="tab-content active">
  <h2>üß™ Non-Sterile Compounding Area (USP &lt;795&gt;)</h2>
  <div style="background:#e8f5e8;padding:10px;border-radius:4px;margin:10px 0;font-size:12px;">
    <strong>USP Requirements:</strong> Temperature: 68-77¬∞F | Humidity: ‚â§60% RH
  </div>
  
  <label>Temperature (¬∞F)</label>
  <input type="number" id="temp795" step="0.1">
  
  <label>Humidity (%)</label>
  <input type="number" id="hum795" step="0.1">
  
  <label>Initials</label>
  <input type="text" id="staff795">
  
  <div style="background:#f8f9fa;padding:15px;border-radius:6px;margin:15px 0;border-left:4px solid #27ae60;">
    <h4 style="margin:0 0 10px 0;color:#27ae60;">üßΩ Daily Cleaning Tasks</h4>
    <div style="display:flex;flex-direction:column;">
      <label class="cleaning-label"><input type="checkbox" id="clean795_surface" class="cleaning-checkbox"> Surface Cleaning</label>
      <label class="cleaning-label"><input type="checkbox" id="clean795_floor" class="cleaning-checkbox"> Floor Cleaning</label>
      <label class="cleaning-label"><input type="checkbox" id="clean795_equipment" class="cleaning-checkbox"> Equipment Cleaning</label>
      <label class="cleaning-label"><input type="checkbox" id="clean795_hood" class="cleaning-checkbox"> Hood Cleaning</label>
    </div>
  </div>
  
  <button onclick="window.recordData('795')" style="background:#27ae60;padding:15px;font-size:16px;">
    üìä Record & Generate Report
  </button>
  
  <!-- History Section -->
  <div class="history-section">
    <div class="history-header" onclick="window.toggleHistory('795')">>
      <h3>üìä Complete History</h3>
      <span class="history-toggle" id="toggle795">‚ñº</span>
    </div>
    <div class="history-content" id="history795">
      <div class="history-stats" id="stats795">
        <!-- Stats will be populated by JavaScript -->
      </div>
      <table style="width:100%;border-collapse:collapse;">
        <thead>
          <tr><th>Date & Time</th><th>Temp (¬∞F)</th><th>Humidity (%)</th><th>Initials</th><th>Status</th><th>Cleaning Tasks</th></tr>
        </thead>
        <tbody id="historyTable795"></tbody>
      </table>
    </div>
  </div>
</div>

<!-- Sterile USP <797> Tab -->
<div id="sterile" class="tab-content">
  <h2>üî¨ Sterile Compounding Area (USP &lt;797&gt;)</h2>
  <div style="background:#e8f4fd;padding:10px;border-radius:4px;margin:10px 0;font-size:12px;">
    <strong>USP Requirements:</strong> Temperature: 68-77¬∞F | Humidity: ‚â§60% RH | Air Pressure: +0.01 to +0.05 inches WC (positive pressure)
  </div>
  
  <label>Temperature (¬∞F)</label>
  <input type="number" id="temp797" step="0.1">
  
  <label>Humidity (%)</label>
  <input type="number" id="hum797" step="0.1">
  
  <label>Air Pressure (inches WC)</label>
  <input type="number" id="pressure797" step="0.001" placeholder="e.g., 0.025">
  
  <label>Initials</label>
  <input type="text" id="staff797">
  
  <div style="background:#f8f9fa;padding:15px;border-radius:6px;margin:15px 0;border-left:4px solid #3498db;">
    <h4 style="margin:0 0 10px 0;color:#3498db;">üßΩ Daily Cleaning Tasks</h4>
    <div style="display:flex;flex-direction:column;">
      <label class="cleaning-label"><input type="checkbox" id="clean797_surface" class="cleaning-checkbox"> Surface Cleaning</label>
      <label class="cleaning-label"><input type="checkbox" id="clean797_floor" class="cleaning-checkbox"> Floor Cleaning</label>
      <label class="cleaning-label"><input type="checkbox" id="clean797_equipment" class="cleaning-checkbox"> Equipment Cleaning</label>
      <label class="cleaning-label"><input type="checkbox" id="clean797_hood" class="cleaning-checkbox"> Hood Cleaning</label>
    </div>
  </div>
  
  <button onclick="window.recordData('797')" style="background:#3498db;padding:15px;font-size:16px;">
    üìä Record & Generate Report
  </button>
  
  <!-- History Section -->
  <div class="history-section">
    <div class="history-header" onclick="window.toggleHistory('797')">>
      <h3>üìä Complete History</h3>
      <span class="history-toggle" id="toggle797">‚ñº</span>
    </div>
    <div class="history-content" id="history797">
      <div class="history-stats" id="stats797">
        <!-- Stats will be populated by JavaScript -->
      </div>
      <table style="width:100%;border-collapse:collapse;">
        <thead>
          <tr><th>Date & Time</th><th>Temp (¬∞F)</th><th>Humidity (%)</th><th>Pressure (" WC)</th><th>Initials</th><th>Status</th><th>Cleaning Tasks</th></tr>
        </thead>
        <tbody id="historyTable797"></tbody>
      </table>
    </div>
  </div>
</div>

<!-- Hazardous USP <800> Tab -->
<div id="hazardous" class="tab-content">
  <h2>‚ö†Ô∏è Hazardous Drug Compounding Area (USP &lt;800&gt;)</h2>
  <div style="background:#fdf2e8;padding:10px;border-radius:4px;margin:10px 0;font-size:12px;">
    <strong>USP Requirements:</strong> Temperature: 68-77¬∞F | Humidity: ‚â§60% RH | Air Pressure: -0.01 to -0.05 inches WC (negative pressure)
  </div>
  
  <label>Temperature (¬∞F)</label>
  <input type="number" id="temp800" step="0.1">
  
  <label>Humidity (%)</label>
  <input type="number" id="hum800" step="0.1">
  
  <label>Air Pressure (inches WC)</label>
  <input type="number" id="pressure800" step="0.001" placeholder="e.g., -0.025">
  
  <label>Initials</label>
  <input type="text" id="staff800">
  
  <div style="background:#f8f9fa;padding:15px;border-radius:6px;margin:15px 0;border-left:4px solid #e67e22;">
    <h4 style="margin:0 0 10px 0;color:#e67e22;">üßΩ Daily Cleaning Tasks</h4>
    <div style="display:flex;flex-direction:column;">
      <label class="cleaning-label"><input type="checkbox" id="clean800_surface" class="cleaning-checkbox"> Surface Cleaning</label>
      <label class="cleaning-label"><input type="checkbox" id="clean800_floor" class="cleaning-checkbox"> Floor Cleaning</label>
      <label class="cleaning-label"><input type="checkbox" id="clean800_equipment" class="cleaning-checkbox"> Equipment Cleaning</label>
      <label class="cleaning-label"><input type="checkbox" id="clean800_hood" class="cleaning-checkbox"> Hood Cleaning</label>
    </div>
  </div>
  
  <button onclick="window.recordData('800')" style="background:#e67e22;padding:15px;font-size:16px;">
    üìä Record & Generate Report
  </button>
  
  <!-- History Section -->
  <div class="history-section">
    <div class="history-header" onclick="window.toggleHistory('800')">>
      <h3>üìä Complete History</h3>
      <span class="history-toggle" id="toggle800">‚ñº</span>
    </div>
    <div class="history-content" id="history800">
      <div class="history-stats" id="stats800">
        <!-- Stats will be populated by JavaScript -->
      </div>
      <table style="width:100%;border-collapse:collapse;">
        <thead>
          <tr><th>Date & Time</th><th>Temp (¬∞F)</th><th>Humidity (%)</th><th>Pressure (" WC)</th><th>Initials</th><th>Status</th><th>Cleaning Tasks</th></tr>
        </thead>
        <tbody id="historyTable800"></tbody>
      </table>
    </div>
  </div>
</div>

</div>

<!-- PDF Generation Library -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<script>
// Environment Detection and Configuration
const isLocalhost = location.hostname === 'localhost' || location.hostname === '127.0.0.1';
const isGitHubPages = location.hostname.includes('github.io') || location.hostname === 'labreporttool.xyz';
const isDevelopment = isLocalhost;
const isProduction = isGitHubPages;

// Configuration
const CONFIG = {
  // Dynamic backend URL based on environment
  BACKEND_URL: isDevelopment ? 'http://localhost:8001' : 'https://labreport-q96c.onrender.com',
  
  // Fallback URLs if primary backend fails
  FALLBACK_URLS: [
    'https://pharmacy-compliance-backend.onrender.com',
    'https://pharmacy-backend-api.onrender.com'
  ],
  
  // Service Account Configuration (no frontend Google API needed)
  USE_SERVICE_ACCOUNT: true,
  TARGET_EMAIL: 'labreporting1177@gmail.com',
  SERVICE_ACCOUNT_EMAIL: 'pharmacy-compliance-reports@lap-reports.iam.gserviceaccount.com',
  TARGET_FOLDER_ID: '1C-5yxY7r0DafqWKrOpq9gtJrOrcCU0Sc',
  
  // Google API Configuration (fallback for direct API access)
  GOOGLE_CLIENT_ID: '113380403214174229428-your-client-id.apps.googleusercontent.com',
  
  // Environment info
  ENVIRONMENT: isDevelopment ? 'development' : 'production',
  
  CREDENTIALS: {
    "admin": "pharmacy123",
    "pharmacist": "compound456", 
    "tech": "sterile789"
  },
  USP_LIMITS: {
    795: {tMin: 68, tMax: 77, hMax: 60},
    797: {tMin: 68, tMax: 77, hMax: 60, pressureMin: 0.01, pressureMax: 0.05},
    800: {tMin: 68, tMax: 77, hMax: 60, pressureMin: -0.05, pressureMax: -0.01}
  },
  AREA_NAMES: {
    '795': 'Non-Sterile Compounding Area (USP <795>)',
    '797': 'Sterile Compounding Area (USP <797>)',
    '800': 'Hazardous Drug Compounding Area (USP <800>)'
  },
  AREA_COLORS: {
    '795': [39, 174, 96],   // Green
    '797': [52, 152, 219],  // Blue  
    '800': [230, 126, 34]   // Orange
  }
};

// State
const state = {
  backend_available: false,
  google_api_loaded: false,
  google_authenticated: false,
  system_initialized: false,
  environment: CONFIG.ENVIRONMENT,
  data795: JSON.parse(localStorage.getItem("data795") || "[]"),
  data797: JSON.parse(localStorage.getItem("data797") || "[]"),
  data800: JSON.parse(localStorage.getItem("data800") || "[]")
};

// Backend service functions
async function checkBackendStatus() {
  console.log(`üîç Environment check: isDevelopment=${isDevelopment}, isProduction=${isProduction}`);
  console.log(`üåê Current hostname: ${location.hostname}`);
  
  // Try primary backend URL first
  const urlsToTry = [CONFIG.BACKEND_URL, ...CONFIG.FALLBACK_URLS];
  
  for (let i = 0; i < urlsToTry.length; i++) {
    const backendUrl = urlsToTry[i];
    console.log(`üîÑ Attempting to connect to backend ${i + 1}/${urlsToTry.length}: ${backendUrl}/status`);
    
    try {
      const response = await fetch(`${backendUrl}/status`, {
        method: 'GET',
        mode: 'cors',
        headers: {
          'Content-Type': 'application/json',
        },
        credentials: 'omit'
      });
      
      if (response.ok) {
        const status = await response.json();
        state.backend_available = true;
        CONFIG.BACKEND_URL = backendUrl; // Update to working URL
        
        console.log(`‚úÖ Connected to backend: ${backendUrl}`);
        
        if (status.drive_service_ready) {
          updateSystemStatus('connected', 'Cloud Backend Connected ‚úÖ', 
            `Automatic uploads enabled - Reports saved to ${CONFIG.TARGET_EMAIL}`);
          console.log('‚úÖ Backend connected with Google Drive ready');
        } else {
          updateSystemStatus('warning', 'Backend Connected (Local Download Mode)', 
            'Backend running but Google Drive not configured - Reports will download to your device');
          console.log('‚ö†Ô∏è Backend connected but Google Drive service not ready');
        }
        return true;
      } else {
        console.log(`‚ùå Backend ${backendUrl} returned status: ${response.status}`);
      }
    } catch (error) {
      console.log(`‚ùå Failed to connect to ${backendUrl}:`, error.message);
      
      // Check if it's a CORS error
      if (error.message.includes('CORS') || error.message.includes('fetch')) {
        console.log('üîß CORS or network error detected - backend may need CORS configuration');
      }
    }
  }
  
  // All backends failed
  state.backend_available = false;
  
  if (isProduction) {
    updateSystemStatus('warning', 'Backend Offline - Local Download Mode', 
      'Cloud backend unavailable - Reports will download to your device');
    console.log('‚ö†Ô∏è All backends unavailable - using local download mode');
    
    // Skip Google API fallback for now - just use local download
    return false;
  } else {
    updateSystemStatus('warning', 'Backend Offline', 
      'Local backend not running - Reports will download locally');
    console.log('‚ö†Ô∏è Local backend not available');
    return false;
  }
}

// Google Identity Services Integration (New Method - No Deprecated APIs)
async function initializeGoogleAPI() {
  if (!isProduction) return false;
  
  try {
    console.log('üîÑ Initializing Google Identity Services for GitHub Pages...');
    
    // Load ONLY Google Identity Services (no old gapi)
    if (!window.google) {
      console.log('üì• Loading Google Identity Services...');
      await loadGoogleIdentityServices();
    }
    
    console.log('üÜî Initializing Google Identity Services...');
    
    // Initialize Google Identity Services for authentication
    window.googleTokenClient = google.accounts.oauth2.initTokenClient({
      client_id: CONFIG.GOOGLE_CLIENT_ID,
      scope: 'https://www.googleapis.com/auth/drive.file',
      callback: async (tokenResponse) => {
        if (tokenResponse && tokenResponse.access_token) {
          state.google_authenticated = true;
          state.access_token = tokenResponse.access_token;
          console.log('‚úÖ Google Drive authentication successful');
          
          // Test upload capability
          try {
            await testGoogleDriveUpload();
            updateSystemStatus('connected', 'Google Drive Connected', 'Direct API integration ready - reports will auto-upload to Google Drive');
          } catch (error) {
            console.warn('‚ö†Ô∏è Google Drive test failed:', error);
            updateSystemStatus('warning', 'Google Drive Connected (Limited)', 'Authentication successful but upload test failed');
          }
        }
      },
      error_callback: (error) => {
        console.error('‚ùå Google authentication error:', error);
        updateSystemStatus('error', 'Authentication Failed', 'Google Drive authentication failed - reports will download locally');
      }
    });
    
    state.google_api_loaded = true;
    console.log('‚úÖ Google Identity Services loaded successfully');
    
    updateSystemStatus('warning', 'Google Drive Authentication Required', 'Click to authenticate with Google Drive for automatic uploads');
    console.log('‚ö†Ô∏è Google Drive authentication required - click status symbol to authenticate');
    
    return true;
  } catch (error) {
    console.error('‚ùå Google Identity Services initialization failed:', error);
    
    let errorMessage = 'Google Identity Services initialization failed';
    if (error.message && error.message.includes('Not a valid origin')) {
      errorMessage = 'Domain not authorized in Google Cloud Console - check setup guide';
    } else if (error.message && error.message.includes('client_id')) {
      errorMessage = 'Google Client ID configuration issue';
    }
    
    updateSystemStatus('error', 'Google API Failed', `${errorMessage} - reports will download locally`);
    return false;
  }
}

// Load Google Identity Services script (New Method Only)
function loadGoogleIdentityServices() {
  return new Promise((resolve, reject) => {
    if (window.google && window.google.accounts) {
      console.log('‚úÖ Google Identity Services already loaded');
      resolve();
      return;
    }
    
    console.log('üì• Loading Google Identity Services script...');
    const script = document.createElement('script');
    script.src = 'https://accounts.google.com/gsi/client';
    script.async = true;
    script.defer = true;
    
    script.onload = () => {
      console.log('‚úÖ Google Identity Services script loaded successfully');
      resolve();
    };
    
    script.onerror = (error) => {
      console.error('‚ùå Failed to load Google Identity Services script:', error);
      reject(new Error('Failed to load Google Identity Services script'));
    };
    
    document.head.appendChild(script);
    
    // Timeout fallback
    setTimeout(() => {
      if (!window.google || !window.google.accounts) {
        reject(new Error('Google Identity Services script loading timeout'));
      }
    }, 15000);
  });
}

// Authenticate with Google (for GitHub Pages) - New Google Identity Services
async function authenticateGoogle() {
  if (!state.google_api_loaded) {
    console.log('üîÑ Google Identity Services not loaded, initializing...');
    const initialized = await initializeGoogleAPI();
    if (!initialized) {
      console.error('‚ùå Cannot authenticate - Google Identity Services initialization failed');
      return false;
    }
  }
  
  try {
    console.log('üîë Starting Google authentication with Identity Services...');
    updateSystemStatus('info', 'Authenticating...', 'Please complete Google Drive authentication in popup window');
    
    if (!window.googleTokenClient) {
      throw new Error('Google Token Client not initialized');
    }
    
    // Request access token using Google Identity Services
    window.googleTokenClient.requestAccessToken();
    
    return true; // The callback will handle the success/failure
  } catch (error) {
    console.error('‚ùå Google authentication failed:', error);
    
    let errorMessage = 'Authentication failed';
    if (error.message.includes('popup')) {
      errorMessage = 'Popup blocked - please allow popups and try again';
    } else if (error.message.includes('access_denied')) {
      errorMessage = 'Access denied - please grant Google Drive permissions';
    }
    
    updateSystemStatus('error', 'Authentication Failed', `${errorMessage} - reports will download locally`);
    return false;
  }
}

// Google Drive upload using REST API directly (No deprecated libraries)
async function uploadToGoogleDrive(fileName, content) {
  if (!state.google_authenticated || !state.access_token) {
    throw new Error('Google Drive not authenticated');
  }
  
  try {
    console.log(`üì§ Uploading ${fileName} to Google Drive...`);
    
    const metadata = {
      name: fileName
    };
    
    // Add folder parent only if TARGET_FOLDER_ID is specified
    if (CONFIG.TARGET_FOLDER_ID) {
      metadata.parents = [CONFIG.TARGET_FOLDER_ID];
      console.log(`üìÅ Uploading to folder: ${CONFIG.TARGET_FOLDER_ID}`);
    } else {
      console.log(`üìÅ Uploading to root Drive folder (testing mode)`);
    }
    
    const form = new FormData();
    form.append('metadata', new Blob([JSON.stringify(metadata)], {type: 'application/json'}));
    form.append('file', content);
    
    const response = await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart', {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${state.access_token}`
      },
      body: form
    });
    
    if (!response.ok) {
      const errorText = await response.text();
      console.error('‚ùå Upload failed response:', errorText);
      
      // Try fallback to root folder if specific folder fails
      if (CONFIG.TARGET_FOLDER_ID && response.status === 404) {
        console.log('üîÑ Retrying upload to root folder...');
        const rootMetadata = { name: fileName };
        const rootForm = new FormData();
        rootForm.append('metadata', new Blob([JSON.stringify(rootMetadata)], {type: 'application/json'}));
        rootForm.append('file', content);
        
        const rootResponse = await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart', {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${state.access_token}`
          },
          body: rootForm
        });
        
        if (rootResponse.ok) {
          const rootResult = await rootResponse.json();
          console.log('‚úÖ File uploaded to root Drive folder successfully:', rootResult);
          return rootResult;
        }
      }
      
      throw new Error(`Upload failed: ${response.status} ${response.statusText} - ${errorText}`);
    }
    
    const result = await response.json();
    console.log('‚úÖ File uploaded to Google Drive successfully:', result);
    return result;
  } catch (error) {
    console.error('‚ùå Google Drive upload failed:', error);
    throw error;
  }
}

// Test Google Drive upload capability
async function testGoogleDriveUpload() {
  try {
    console.log('üß™ Testing Google Drive upload capability...');
    
    if (!state.access_token) {
      throw new Error('No access token available');
    }
    
    // Test 1: Check Drive API access
    console.log('üîç Testing Drive API access...');
    const aboutResponse = await fetch('https://www.googleapis.com/drive/v3/about?fields=user', {
      headers: {
        'Authorization': `Bearer ${state.access_token}`
      }
    });
    
    if (!aboutResponse.ok) {
      throw new Error(`Drive API access failed: ${aboutResponse.status} ${aboutResponse.statusText}`);
    }
    
    const aboutData = await aboutResponse.json();
    console.log('‚úÖ Drive API access successful. User:', aboutData.user?.emailAddress);
    
    // Test 2: Check folder access (if folder ID specified)
    if (CONFIG.TARGET_FOLDER_ID) {
      console.log(`üîç Testing folder access: ${CONFIG.TARGET_FOLDER_ID}`);
      const folderResponse = await fetch(`https://www.googleapis.com/drive/v3/files/${CONFIG.TARGET_FOLDER_ID}?fields=id,name,parents`, {
        headers: {
          'Authorization': `Bearer ${state.access_token}`
        }
      });
      
      if (!folderResponse.ok) {
        console.warn(`‚ö†Ô∏è Folder access failed: ${folderResponse.status} ${folderResponse.statusText}`);
        console.log('üîÑ Will use root Drive folder instead');
      } else {
        const folderData = await folderResponse.json();
        console.log('‚úÖ Folder access successful:', folderData);
      }
    } else {
      console.log('üìÅ Using root Drive folder (no specific folder configured)');
    }
    
    // Test 3: Create a small test file
    console.log('üß™ Creating test file...');
    const testContent = new Blob(['Google Drive upload test - ' + new Date().toISOString()], {type: 'text/plain'});
    const testFileName = 'test-upload-' + Date.now() + '.txt';
    
    await uploadToGoogleDrive(testFileName, testContent);
    console.log('‚úÖ Test upload successful');
    
    return true;
  } catch (error) {
    console.error('‚ùå Google Drive test failed:', error);
    throw error;
  }
}

// Update system status display
function updateSystemStatus(status, text, details) {
  const statusDiv = document.getElementById('systemStatus');
  const statusText = document.getElementById('systemStatusText');
  const statusDetails = document.getElementById('systemDetails');
  const statusSymbol = document.getElementById('statusSymbol');
  
  if (statusDiv && statusText && statusDetails && statusSymbol) {
    statusDiv.className = `system-status ${status}`;
    statusText.textContent = text;
    statusDetails.textContent = details;
    
    // Update status symbol based on connection status
    switch(status) {
      case 'connected':
        statusSymbol.textContent = 'üöÄ';
        statusSymbol.title = 'Render Cloud Backend Connected - Ready to upload reports to Google Drive';
        // Make status clickable for re-authentication if needed
        if (isProduction && !state.google_authenticated) {
          statusSymbol.style.cursor = 'pointer';
          statusSymbol.onclick = authenticateGoogle;
        }
        break;
      case 'warning':
        statusSymbol.textContent = '‚ö†Ô∏è';
        statusSymbol.title = isProduction ? 'Click to authenticate with Google Drive' : 'Render backend offline - Files will download locally';
        // Make clickable on GitHub Pages for authentication
        if (isProduction) {
          statusSymbol.style.cursor = 'pointer';
          statusSymbol.onclick = authenticateGoogle;
        }
        break;
      case 'error':
        statusSymbol.textContent = '‚ùå';
        statusSymbol.title = 'Connection failed - Reports will download locally';
        break;
      case 'info':
        statusSymbol.textContent = 'üîÑ';
        statusSymbol.title = 'Connecting to Render cloud backend...';
        break;
      default:
        statusSymbol.textContent = 'üîÑ';
        statusSymbol.title = 'Initializing Render cloud connection...';
    }
  }
}

async function uploadToBackend(fileName, content, contentType = 'application/pdf') {
  // Use service account backend for all uploads
  if (state.backend_available) {
    try {
      let fileContent = content;
      let encoding = 'text';
      
      if (content instanceof Blob) {
        const arrayBuffer = await content.arrayBuffer();
        fileContent = btoa(String.fromCharCode.apply(null, new Uint8Array(arrayBuffer)));
        encoding = 'base64';
      }
      
      const response = await fetch(`${CONFIG.BACKEND_URL}/upload`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          filename: fileName,
          content: fileContent,
          content_type: contentType,
          encoding: encoding
        })
      });
      
      if (response.ok) {
        const result = await response.json();
        console.log(`‚úÖ File uploaded to ${CONFIG.TARGET_EMAIL} Google Drive via service account`);
        console.log(`üìÅ File ID: ${result.file_id}`);
        console.log(`üîó View link: ${result.web_view_link}`);
        return true;
      }
      throw new Error('Service account upload failed');
    } catch (error) {
      console.error('‚ùå Service account upload error:', error);
    }
  }
  
  // Fallback: Download locally
  console.log('üì• Backend not available - downloading file locally');
  downloadFile(fileName, content);
  return true;
}

// Fallback: Download file locally
function downloadFile(fileName, content) {
  let blob;
  if (content instanceof Blob) {
    blob = content;
  } else {
    blob = new Blob([content], { type: 'text/plain' });
  }
  
  const url = window.URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = fileName;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  window.URL.revokeObjectURL(url);
}

// PDF text cleaning function
function cleanTextForPDF(text) {
  return text
    .replace(/¬∞/g, ' degrees ')
    .replace(/‚â§/g, ' or less than ')
    .replace(/‚â•/g, ' or greater than ')
    .replace(/¬±/g, ' plus/minus ')
    .replace(/‚úì/g, 'PASS')
    .replace(/‚úó/g, 'FAIL')
    .replace(/üß™|üìä|üìã|üìù|‚ö†Ô∏è|‚úÖ/g, '')
    .replace(/"/g, ' inches')
    .trim();
}

function generateAreaPDF(area, data) {
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();
  
  const primaryColor = CONFIG.AREA_COLORS[area];
  const textColor = [44, 62, 80];
  const user = sessionStorage.getItem("user") || "Unknown";
  const today = new Date().toLocaleDateString();
  
  // Header
  doc.setFillColor(...primaryColor);
  doc.rect(0, 0, 210, 30, 'F');
  doc.setTextColor(255, 255, 255);
  doc.setFontSize(18);
  doc.setFont(undefined, 'bold');
  doc.text(cleanTextForPDF('Pharmacy Compounding Compliance Report'), 20, 15);
  doc.setFontSize(12);
  doc.text(cleanTextForPDF(CONFIG.AREA_NAMES[area]), 20, 22);
  
  // Report info
  doc.setTextColor(...textColor);
  doc.setFontSize(10);
  let yPos = 45;
  doc.text(`Generated: ${today}`, 20, yPos);
  doc.text(`By: ${user}`, 120, yPos);
  yPos += 15;
  
  // Summary
  const totalRecords = data.length;
  const compliantRecords = data.filter(entry => entry.compliant).length;
  const complianceRate = totalRecords > 0 ? ((compliantRecords / totalRecords) * 100).toFixed(1) : 0;
  
  doc.setFillColor(248, 249, 250);
  doc.rect(15, yPos, 180, 25, 'F');
  doc.setTextColor(...primaryColor);
  doc.setFontSize(14);
  doc.setFont(undefined, 'bold');
  doc.text('COMPLIANCE SUMMARY', 20, yPos + 8);
  doc.setTextColor(...textColor);
  doc.setFontSize(10);
  doc.setFont(undefined, 'normal');
  doc.text(`Total Records: ${totalRecords} | Compliance Rate: ${complianceRate}% | Compliant: ${compliantRecords}`, 20, yPos + 15);
  
  yPos += 35;
  
  // USP Requirements
  doc.setTextColor(...primaryColor);
  doc.setFontSize(12);
  doc.setFont(undefined, 'bold');
  doc.text('USP REQUIREMENTS', 20, yPos);
  doc.setTextColor(...textColor);
  doc.setFontSize(10);
  doc.setFont(undefined, 'normal');
  yPos += 8;
  doc.text('- Temperature: 68-77 degrees F', 25, yPos);
  yPos += 5;
  doc.text('- Humidity: 60% RH or less', 25, yPos);
  yPos += 5;
  
  if (area === '797') {
    doc.text('- Air Pressure: +0.01 to +0.05 inches WC (positive)', 25, yPos);
    yPos += 5;
  } else if (area === '800') {
    doc.text('- Air Pressure: -0.01 to -0.05 inches WC (negative)', 25, yPos);
    yPos += 5;
  }
  
  // Recent records table (simplified)
  if (data.length > 0) {
    yPos += 10;
    doc.setTextColor(...primaryColor);
    doc.setFontSize(12);
    doc.setFont(undefined, 'bold');
    doc.text('RECENT RECORDS (Last 5)', 20, yPos);
    yPos += 10;
    
    const recentRecords = data.slice(-5).reverse();
    recentRecords.forEach((entry, index) => {
      if (yPos > 270) return; // Page limit
      
      doc.setTextColor(entry.compliant ? textColor[0] : 220, entry.compliant ? textColor[1] : 53, entry.compliant ? textColor[2] : 69);
      doc.setFontSize(8);
      
      const date = new Date(entry.timestamp).toLocaleDateString();
      const status = entry.compliant ? 'PASS' : 'FAIL';
      const pressure = entry.pressure !== null ? ` | ${entry.pressure}"WC` : '';
      
      doc.text(`${date} | ${entry.temp}F | ${entry.hum}%RH${pressure} | ${entry.staff} | ${status}`, 20, yPos);
      yPos += 6;
    });
  }
  
  // Footer
  doc.setTextColor(108, 117, 125);
  doc.setFontSize(8);
  doc.text('Generated by Pharmacy Compounding Compliance Log System', 20, 285);
  
  return doc.output('blob');
}

// Utility functions
const utils = {
  // Get data for area
  getData(area) {
    return state[`data${area}`];
  },
  
  // Save data for area
  saveData(area, data) {
    state[`data${area}`] = data;
    localStorage.setItem(`data${area}`, JSON.stringify(data));
  },
  
  // Get cleaning tasks for area
  getCleaningTasks(area) {
    const tasks = [];
    ['surface', 'floor', 'equipment', 'hood'].forEach(task => {
      const checkbox = document.getElementById(`clean${area}_${task}`);
      if (checkbox?.checked) {
        tasks.push(task.charAt(0).toUpperCase() + task.slice(1) + ' Cleaning');
      }
    });
    return tasks;
  },
  
  // Clear cleaning checkboxes
  clearCleaningTasks(area) {
    ['surface', 'floor', 'equipment', 'hood'].forEach(task => {
      const checkbox = document.getElementById(`clean${area}_${task}`);
      if (checkbox) checkbox.checked = false;
    });
  },
  
  // Format filename
  getFileName() {
    return `Labreport - ${new Date().toLocaleDateString('en-US', { 
      year: 'numeric', 
      month: '2-digit', 
      day: '2-digit' 
    }).replace(/\//g, '-')}.pdf`;
  }
};

// Handle Enter key press on login form - Global scope
window.handleLoginKeyPress = function(event) {
  if (event.key === 'Enter') {
    window.login();
  }
}

window.login = function() {
  const user = document.getElementById("loginUser").value.trim().toLowerCase();
  const pass = document.getElementById("loginPass").value;
  const error = document.getElementById("loginError");
  
  if (CONFIG.CREDENTIALS[user] === pass) {
    sessionStorage.setItem("loggedIn", "true");
    sessionStorage.setItem("user", user);
    window.showApp();
  } else {
    error.style.display = "block";
    error.textContent = "Invalid username or password";
  }
}

// Logout function - Global scope
window.logout = function() {
  sessionStorage.clear();
  document.getElementById("loginScreen").style.display = "block";
  document.getElementById("app").style.display = "none";
}

// Show app - Global scope
window.showApp = function() {
  document.getElementById("loginScreen").style.display = "none";
  document.getElementById("app").style.display = "block";
}

// Check if logged in
function checkLogin() {
  if (sessionStorage.getItem("loggedIn") === "true") {
    showApp();
  }
}

// Tab switching - Global scope
window.switchTab = function(tabName) {
  const tabs = document.querySelectorAll('.tab-content');
  tabs.forEach(tab => tab.classList.remove('active'));
  
  const buttons = document.querySelectorAll('.tab-button');
  buttons.forEach(btn => btn.classList.remove('active'));
  
  document.getElementById(tabName).classList.add('active');
  
  const activeBtn = document.querySelector(`.tab-button.${tabName}`);
  if (activeBtn) activeBtn.classList.add('active');
}

window.recordData = async function(area) {
  const temp = parseFloat(document.getElementById(`temp${area}`).value);
  const hum = parseFloat(document.getElementById(`hum${area}`).value);
  const staff = document.getElementById(`staff${area}`).value.trim();
  
  let pressure = null;
  if (area === '797' || area === '800') {
    pressure = parseFloat(document.getElementById(`pressure${area}`).value);
    if (isNaN(pressure)) {
      // Highlight missing pressure field and show status message
      document.getElementById(`pressure${area}`).style.borderColor = '#dc3545';
      showStatusMessage("Please enter air pressure reading", 'error');
      return;
    }
  }
  
  if (isNaN(temp) || isNaN(hum) || !staff) {
    // Highlight missing fields and show status message
    if (isNaN(temp)) document.getElementById(`temp${area}`).style.borderColor = '#dc3545';
    if (isNaN(hum)) document.getElementById(`hum${area}`).style.borderColor = '#dc3545';
    if (!staff) document.getElementById(`staff${area}`).style.borderColor = '#dc3545';
    
    showStatusMessage("Please fill in all required fields", 'error');
    return;
  }
  
  // Check compliance
  const limit = CONFIG.USP_LIMITS[area];
  const tempOK = temp >= limit.tMin && temp <= limit.tMax;
  const humOK = hum <= limit.hMax;
  const pressureOK = !pressure || (pressure >= limit.pressureMin && pressure <= limit.pressureMax);
  const compliant = tempOK && humOK && pressureOK;
  
  // Create entry
  const entry = {
    timestamp: new Date().toLocaleString(),
    temp, hum, pressure, staff,
    status: compliant ? "COMPLIANT" : "NON-COMPLIANT",
    compliant,
    cleaningTasks: utils.getCleaningTasks(area)
  };
  
  // Save data
  const data = utils.getData(area);
  data.push(entry);
  utils.saveData(area, data);
  
  // Generate and upload PDF
  const fileName = utils.getFileName();
  const reportPDF = generateAreaPDF(area, data);
  await uploadToBackend(fileName, reportPDF, 'application/pdf');
  
  // Clear form
  document.getElementById(`temp${area}`).value = '';
  document.getElementById(`hum${area}`).value = '';
  if (pressure !== null) document.getElementById(`pressure${area}`).value = '';
  document.getElementById(`staff${area}`).value = '';
  utils.clearCleaningTasks(area);
  
  // Update display
  loadData();
  
  // Show result
  let uploadMethod;
  if (state.backend_available) {
    uploadMethod = 'Google Drive (via backend service)';
  } else if (isProduction && state.google_authenticated) {
    uploadMethod = 'Google Drive (direct API)';
  } else {
    uploadMethod = 'local download';
  }
  
  const cleaningInfo = entry.cleaningTasks.length > 0 ? `\nCleaning: ${entry.cleaningTasks.join(', ')}` : '';
  const pressureInfo = pressure !== null ? `, Pressure: ${pressure}" WC` : '';
  
  // Show status message instead of popup
  if (!compliant) {
    showStatusMessage(`NON-COMPLIANT reading recorded. Report saved: ${uploadMethod}. CORRECTIVE ACTION REQUIRED.`, 'warning', 6000);
  } else {
    showStatusMessage(`Compliant reading recorded! Report saved: ${uploadMethod}`, 'success', 4000);
  }
}

// History toggle functionality - Global scope
window.toggleHistory = function(area) {
  const content = document.getElementById(`history${area}`);
  const toggle = document.getElementById(`toggle${area}`);
  
  if (content.classList.contains('show')) {
    content.classList.remove('show');
    toggle.classList.remove('expanded');
  } else {
    content.classList.add('show');
    toggle.classList.add('expanded');
    loadHistoryData(area);
  }
}

function loadHistoryData(area) {
  const data = utils.getData(area);
  updateHistoryStats(area, data);
  loadHistoryTable(area, data);
}

function updateHistoryStats(area, data) {
  const statsDiv = document.getElementById(`stats${area}`);
  const totalRecords = data.length;
  const compliantRecords = data.filter(entry => entry.compliant).length;
  const complianceRate = totalRecords > 0 ? ((compliantRecords / totalRecords) * 100).toFixed(1) : 0;
  
  let dateRange = 'No data';
  if (data.length > 0) {
    const firstDate = new Date(data[0].timestamp).toLocaleDateString();
    const lastDate = new Date(data[data.length - 1].timestamp).toLocaleDateString();
    dateRange = firstDate === lastDate ? firstDate : `${firstDate} - ${lastDate}`;
  }
  
  statsDiv.innerHTML = `
    <div class="history-stat"><span class="number">${totalRecords}</span><span class="label">Total Records</span></div>
    <div class="history-stat"><span class="number">${complianceRate}%</span><span class="label">Compliance Rate</span></div>
    <div class="history-stat"><span class="number">${compliantRecords}</span><span class="label">Compliant</span></div>
    <div class="history-stat"><span class="number">${totalRecords - compliantRecords}</span><span class="label">Non-Compliant</span></div>
    <div class="history-stat"><span class="number">${dateRange}</span><span class="label">Date Range</span></div>
  `;
}

function loadHistoryTable(area, data) {
  const table = document.getElementById(`historyTable${area}`);
  table.innerHTML = '';
  
  data.slice().reverse().forEach(entry => {
    const row = table.insertRow();
    row.className = entry.compliant ? '' : 'out';
    
    const cleaningTasks = entry.cleaningTasks?.length > 0 ? entry.cleaningTasks.join(', ') : 'None';
    const pressureValue = entry.pressure !== null && entry.pressure !== undefined ? entry.pressure : 'N/A';
    
    if (area === '795') {
      row.innerHTML = `<td>${entry.timestamp}</td><td>${entry.temp}</td><td>${entry.hum}</td><td>${entry.staff}</td><td>${entry.status}</td><td>${cleaningTasks}</td>`;
    } else {
      row.innerHTML = `<td>${entry.timestamp}</td><td>${entry.temp}</td><td>${entry.hum}</td><td>${pressureValue}</td><td>${entry.staff}</td><td>${entry.status}</td><td>${cleaningTasks}</td>`;
    }
  });
}

function loadData() {
  ['795', '797', '800'].forEach(area => {
    const historyContent = document.getElementById(`history${area}`);
    if (historyContent?.classList.contains('show')) {
      loadHistoryData(area);
    }
  });
}

// Show status message instead of popup
function showStatusMessage(message, type = 'info', duration = 4000) {
  const statusDiv = document.getElementById('statusMessage');
  if (!statusDiv) return;
  
  statusDiv.textContent = message;
  statusDiv.style.display = 'block';
  
  // Set colors based on type
  switch(type) {
    case 'success':
      statusDiv.style.backgroundColor = '#d4edda';
      statusDiv.style.color = '#155724';
      statusDiv.style.border = '1px solid #c3e6cb';
      break;
    case 'error':
      statusDiv.style.backgroundColor = '#f8d7da';
      statusDiv.style.color = '#721c24';
      statusDiv.style.border = '1px solid #f5c6cb';
      break;
    case 'warning':
      statusDiv.style.backgroundColor = '#fff3cd';
      statusDiv.style.color = '#856404';
      statusDiv.style.border = '1px solid #ffeaa7';
      break;
    default:
      statusDiv.style.backgroundColor = '#d1ecf1';
      statusDiv.style.color = '#0c5460';
      statusDiv.style.border = '1px solid #bee5eb';
  }
  
  // Auto-hide after duration
  setTimeout(() => {
    statusDiv.style.display = 'none';
  }, duration);
}

// Clear field highlighting when user starts typing
function clearFieldHighlight(fieldId) {
  document.getElementById(fieldId).style.borderColor = '';
}

// Add event listeners to clear highlighting
document.addEventListener('DOMContentLoaded', function() {
  // Add input event listeners to clear red borders
  ['795', '797', '800'].forEach(area => {
    const tempField = document.getElementById(`temp${area}`);
    const humField = document.getElementById(`hum${area}`);
    const staffField = document.getElementById(`staff${area}`);
    const pressureField = document.getElementById(`pressure${area}`);
    
    if (tempField) tempField.addEventListener('input', () => clearFieldHighlight(`temp${area}`));
    if (humField) humField.addEventListener('input', () => clearFieldHighlight(`hum${area}`));
    if (staffField) staffField.addEventListener('input', () => clearFieldHighlight(`staff${area}`));
    if (pressureField) pressureField.addEventListener('input', () => clearFieldHighlight(`pressure${area}`));
  });
  
  checkLogin();
  
  // Update environment info display
  const envInfo = document.getElementById('environmentInfo');
  if (envInfo) {
    envInfo.textContent = `${CONFIG.ENVIRONMENT} (${location.hostname})`;
  }
  
  // Show environment info in console
  console.log(`üåç Environment: ${CONFIG.ENVIRONMENT}`);
  console.log(`üîó Backend URL: ${CONFIG.BACKEND_URL}`);
  console.log(`üìç Domain: ${location.hostname}`);
  console.log(`üè† Is Development: ${isDevelopment}`);
  console.log(`üåê Is Production: ${isProduction}`);
  console.log(`üìß Target Email: ${CONFIG.TARGET_EMAIL}`);
  console.log(`üîë Service Account: ${CONFIG.SERVICE_ACCOUNT_EMAIL}`);
  
  updateSystemStatus('info', 'Initializing System...', `Checking ${CONFIG.ENVIRONMENT} services...`);
  
  setTimeout(async () => {
    await checkBackendStatus();
    state.system_initialized = true;
  }, 1000);
});
</script>

</body>
</html>