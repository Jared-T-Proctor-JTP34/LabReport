<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Pharmacy Compounding Compliance Log</title>

<style>
body { 
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
  font-weight: 600; 
  background: #f4f6f9; 
  margin: 20px; 
}
h1, h2 { 
  color: #2c3e50; 
  font-weight: 700; 
}
section { 
  background: #fff; 
  padding: 20px; 
  margin-bottom: 20px; 
  border-radius: 8px; 
  box-shadow: 0 2px 4px rgba(0,0,0,0.1); 
}
label { 
  display: block; 
  margin-top: 10px; 
  font-weight: 600; 
}
input, select, button { 
  padding: 10px; 
  margin-top: 5px; 
  width: 100%; 
  max-width: 300px; 
  font-family: inherit; 
  font-weight: 500; 
  border-radius: 6px; 
  border: 1px solid #ddd;
}
button { 
  background: #3498db; 
  color: white; 
  border: none; 
  cursor: pointer; 
  font-weight: 600; 
  max-width: none;
}
button:hover { 
  background: #2980b9; 
}
.alert { 
  color: red; 
  font-weight: bold; 
}
table { 
  width: 100%; 
  border-collapse: collapse; 
  margin-top: 15px; 
}
th, td { 
  border: 1px solid #ccc; 
  padding: 10px; 
}
th { 
  background: #ecf0f1; 
  font-weight: 700; 
}
.out { 
  background: #ffe6e6; 
}

/* Tab Styles */
.tab-nav { 
  display: flex; 
  background: #fff; 
  border-radius: 6px 6px 0 0; 
  box-shadow: 0 2px 4px rgba(0,0,0,0.1); 
  margin-top: 20px;
}
.tab-button { 
  flex: 1; 
  padding: 15px 20px; 
  border: none; 
  cursor: pointer; 
  font-size: 14px; 
  font-weight: bold;
  border-right: 1px solid #bdc3c7;
  max-width: none;
  width: auto;
}
.tab-button:last-child { 
  border-right: none; 
}
.tab-button.active { 
  background: #3498db; 
  color: white; 
}
.tab-button:hover:not(.active) { 
  background: #d5dbdb; 
}

.tab-button.non-sterile { 
  background: #2ecc71; 
  color: white; 
}
.tab-button.non-sterile.active { 
  background: #27ae60; 
}

.tab-button.sterile { 
  background: #3498db; 
  color: white; 
}
.tab-button.sterile.active { 
  background: #2980b9; 
}

.tab-button.hazardous { 
  background: #e74c3c; 
  color: white; 
}
.tab-button.hazardous.active { 
  background: #c0392b; 
}

.tab-button.cleaning { 
  background: #9b59b6; 
  color: white; 
}
.tab-button.cleaning.active { 
  background: #8e44ad; 
}

.tab-content { 
  display: none; 
  background: #fff;
  padding: 20px;
  border-radius: 0 0 6px 6px;
  box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}
.tab-content.active { 
  display: block; 
}

.status-indicator {
  padding: 8px;
  margin: 10px 0;
  border-radius: 4px;
  font-weight: 600;
  text-align: center;
}
.status-compliant {
  background: #d4edda;
  color: #155724;
}
.status-non-compliant {
  background: #f8d7da;
  color: #721c24;
}
.status-pending {
  background: #fff3cd;
  color: #856404;
}

/* Custom checkbox styling */
.cleaning-checkbox {
  width: 20px !important;
  height: 20px !important;
  margin-right: 12px !important;
  cursor: pointer;
  accent-color: #3498db;
}

.cleaning-label {
  display: flex;
  align-items: center;
  margin: 2px 0;
  font-size: 14px;
  font-weight: 600;
  cursor: pointer;
  padding: 4px 8px;
  border-radius: 6px;
  transition: background-color 0.2s;
}

.cleaning-label:hover {
  background-color: #f8f9fa;
}

/* History section styling */
.history-section {
  margin-top: 30px;
  border: 1px solid #dee2e6;
  border-radius: 8px;
  overflow: hidden;
}

.history-header {
  background: #f8f9fa;
  padding: 15px 20px;
  cursor: pointer;
  border-bottom: 1px solid #dee2e6;
  display: flex;
  justify-content: space-between;
  align-items: center;
  transition: background-color 0.2s;
}

.history-header:hover {
  background: #e9ecef;
}

.history-header h3 {
  margin: 0;
  font-size: 16px;
  color: #495057;
}

.history-toggle {
  font-size: 18px;
  color: #6c757d;
  transition: transform 0.2s;
}

.history-toggle.expanded {
  transform: rotate(180deg);
}

.history-content {
  display: none;
  padding: 20px;
  background: white;
}

.history-content.show {
  display: block;
}

.history-stats {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
  gap: 15px;
  margin-bottom: 20px;
  padding: 15px;
  background: #f8f9fa;
  border-radius: 6px;
}

.history-stat {
  text-align: center;
}

.history-stat .number {
  font-size: 24px;
  font-weight: 700;
  color: #495057;
  display: block;
}

.history-stat .label {
  font-size: 12px;
  color: #6c757d;
  text-transform: uppercase;
  font-weight: 600;
}
</style>
</head>

<body>

<!-- Login Screen -->
<div id="loginScreen" style="max-width:400px;margin:80px auto;padding:20px;background:#fff;border-radius:8px;box-shadow:0 2px 6px rgba(0,0,0,0.15)">
  <h2>Compliance Log Access</h2>
  <div style="background:#f8f9fa;padding:10px;border-radius:4px;margin:10px 0;font-size:12px;color:#666;">
    <strong>Demo Credentials:</strong><br>
    admin / pharmacy123<br>
    pharmacist / compound456<br>
    tech / sterile789
  </div>
  <label>Username</label>
  <input type="text" id="loginUser" onkeypress="handleLoginKeyPress(event)">
  <label>Password</label>
  <input type="password" id="loginPass" onkeypress="handleLoginKeyPress(event)">
  <button onclick="login()">Login</button>
  <p id="loginError" class="alert" style="display:none">Invalid credentials</p>
</div>

<!-- Main App -->
<div id="app" style="display:none">

<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;padding:15px 0;border-bottom:2px solid #ecf0f1;">
  <h1 style="margin:0;">Pharmacy Compounding Compliance Log</h1>
  <button onclick="logout()" style="background:#e74c3c;padding:10px 20px;">Logout</button>
</div>

<!-- Tabbed Interface -->
<div class="tab-nav">
  <button class="tab-button non-sterile active" onclick="switchTab('non-sterile')">üß™ Non-Sterile (&lt;795&gt;)</button>
  <button class="tab-button sterile" onclick="switchTab('sterile')">üî¨ Sterile (&lt;797&gt;)</button>
  <button class="tab-button hazardous" onclick="switchTab('hazardous')">‚ö†Ô∏è Hazardous (&lt;800&gt;)</button>
</div>

<!-- Non-Sterile USP <795> Tab -->
<div id="non-sterile" class="tab-content active">
  <h2>üß™ Non-Sterile Compounding Area (USP &lt;795&gt;)</h2>
  <div style="background:#e8f5e8;padding:10px;border-radius:4px;margin:10px 0;font-size:12px;">
    <strong>USP Requirements:</strong> Temperature: 68-77¬∞F | Humidity: ‚â§60% RH
  </div>
  
  <label>Temperature (¬∞F)</label>
  <input type="number" id="temp795" step="0.1">
  
  <label>Humidity (%)</label>
  <input type="number" id="hum795" step="0.1">
  
  <label>Initials</label>
  <input type="text" id="staff795">
  
  <div style="background:#f8f9fa;padding:15px;border-radius:6px;margin:15px 0;border-left:4px solid #27ae60;">
    <h4 style="margin:0 0 10px 0;color:#27ae60;">üßΩ Daily Cleaning Tasks</h4>
    <div style="display:flex;flex-direction:column;">
      <label class="cleaning-label"><input type="checkbox" id="clean795_surface" class="cleaning-checkbox"> Surface Cleaning</label>
      <label class="cleaning-label"><input type="checkbox" id="clean795_floor" class="cleaning-checkbox"> Floor Cleaning</label>
      <label class="cleaning-label"><input type="checkbox" id="clean795_equipment" class="cleaning-checkbox"> Equipment Cleaning</label>
      <label class="cleaning-label"><input type="checkbox" id="clean795_hood" class="cleaning-checkbox"> Hood Cleaning</label>
    </div>
  </div>
  
  <button onclick="recordData('795')" style="background:#27ae60;padding:15px;font-size:16px;">
    üìä Get Report
  </button>
  
  <!-- History Section -->
  <div class="history-section">
    <div class="history-header" onclick="toggleHistory('795')">
      <h3>üìä Complete History</h3>
      <span class="history-toggle" id="toggle795">‚ñº</span>
    </div>
    <div class="history-content" id="history795">
      <div class="history-stats" id="stats795">
        <!-- Stats will be populated by JavaScript -->
      </div>
      <table style="width:100%;border-collapse:collapse;">
        <thead>
          <tr><th>Date & Time</th><th>Temp (¬∞F)</th><th>Humidity (%)</th><th>Initials</th><th>Status</th><th>Cleaning Tasks</th></tr>
        </thead>
        <tbody id="historyTable795"></tbody>
      </table>
    </div>
  </div>
</div>

<!-- Sterile USP <797> Tab -->
<div id="sterile" class="tab-content">
  <h2>üî¨ Sterile Compounding Area (USP &lt;797&gt;)</h2>
  <div style="background:#e8f4fd;padding:10px;border-radius:4px;margin:10px 0;font-size:12px;">
    <strong>USP Requirements:</strong> Temperature: 68-77¬∞F | Humidity: ‚â§60% RH | Air Pressure: +0.01 to +0.05 inches WC (positive pressure)
  </div>
  
  <label>Temperature (¬∞F)</label>
  <input type="number" id="temp797" step="0.1">
  
  <label>Humidity (%)</label>
  <input type="number" id="hum797" step="0.1">
  
  <label>Air Pressure (inches WC)</label>
  <input type="number" id="pressure797" step="0.001" placeholder="e.g., 0.025">
  
  <label>Initials</label>
  <input type="text" id="staff797">
  
  <div style="background:#f8f9fa;padding:15px;border-radius:6px;margin:15px 0;border-left:4px solid #3498db;">
    <h4 style="margin:0 0 10px 0;color:#3498db;">üßΩ Daily Cleaning Tasks</h4>
    <div style="display:flex;flex-direction:column;">
      <label class="cleaning-label"><input type="checkbox" id="clean797_surface" class="cleaning-checkbox"> Surface Cleaning</label>
      <label class="cleaning-label"><input type="checkbox" id="clean797_floor" class="cleaning-checkbox"> Floor Cleaning</label>
      <label class="cleaning-label"><input type="checkbox" id="clean797_equipment" class="cleaning-checkbox"> Equipment Cleaning</label>
      <label class="cleaning-label"><input type="checkbox" id="clean797_hood" class="cleaning-checkbox"> Hood Cleaning</label>
    </div>
  </div>
  
  <button onclick="recordData('797')" style="background:#3498db;padding:15px;font-size:16px;">
    üìä Get Report
  </button>
  
  <!-- History Section -->
  <div class="history-section">
    <div class="history-header" onclick="toggleHistory('797')">
      <h3>üìä Complete History</h3>
      <span class="history-toggle" id="toggle797">‚ñº</span>
    </div>
    <div class="history-content" id="history797">
      <div class="history-stats" id="stats797">
        <!-- Stats will be populated by JavaScript -->
      </div>
      <table style="width:100%;border-collapse:collapse;">
        <thead>
          <tr><th>Date & Time</th><th>Temp (¬∞F)</th><th>Humidity (%)</th><th>Pressure (" WC)</th><th>Initials</th><th>Status</th><th>Cleaning Tasks</th></tr>
        </thead>
        <tbody id="historyTable797"></tbody>
      </table>
    </div>
  </div>
</div>

<!-- Hazardous USP <800> Tab -->
<div id="hazardous" class="tab-content">
  <h2>‚ö†Ô∏è Hazardous Drug Compounding Area (USP &lt;800&gt;)</h2>
  <div style="background:#fdf2e8;padding:10px;border-radius:4px;margin:10px 0;font-size:12px;">
    <strong>USP Requirements:</strong> Temperature: 68-77¬∞F | Humidity: ‚â§60% RH
  </div>
  
  <label>Temperature (¬∞F)</label>
  <input type="number" id="temp800" step="0.1">
  
  <label>Humidity (%)</label>
  <input type="number" id="hum800" step="0.1">
  
  <label>Initials</label>
  <input type="text" id="staff800">
  
  <div style="background:#f8f9fa;padding:15px;border-radius:6px;margin:15px 0;border-left:4px solid #e67e22;">
    <h4 style="margin:0 0 10px 0;color:#e67e22;">üßΩ Daily Cleaning Tasks</h4>
    <div style="display:flex;flex-direction:column;">
      <label class="cleaning-label"><input type="checkbox" id="clean800_surface" class="cleaning-checkbox"> Surface Cleaning</label>
      <label class="cleaning-label"><input type="checkbox" id="clean800_floor" class="cleaning-checkbox"> Floor Cleaning</label>
      <label class="cleaning-label"><input type="checkbox" id="clean800_equipment" class="cleaning-checkbox"> Equipment Cleaning</label>
      <label class="cleaning-label"><input type="checkbox" id="clean800_hood" class="cleaning-checkbox"> Hood Cleaning</label>
    </div>
  </div>
  
  <button onclick="recordData('800')" style="background:#e67e22;padding:15px;font-size:16px;">
    üìä Get Report
  </button>
  
  <!-- History Section -->
  <div class="history-section">
    <div class="history-header" onclick="toggleHistory('800')">
      <h3>üìä Complete History</h3>
      <span class="history-toggle" id="toggle800">‚ñº</span>
    </div>
    <div class="history-content" id="history800">
      <div class="history-stats" id="stats800">
        <!-- Stats will be populated by JavaScript -->
      </div>
      <table style="width:100%;border-collapse:collapse;">
        <thead>
          <tr><th>Date & Time</th><th>Temp (¬∞F)</th><th>Humidity (%)</th><th>Pressure (" WC)</th><th>Initials</th><th>Status</th><th>Cleaning Tasks</th></tr>
        </thead>
        <tbody id="historyTable800"></tbody>
      </table>
    </div>
  </div>
</div>

</div>

<script>
// History toggle functionality
function toggleHistory(area) {
  const content = document.getElementById(`history${area}`);
  const toggle = document.getElementById(`toggle${area}`);
  
  if (content.classList.contains('show')) {
    content.classList.remove('show');
    toggle.classList.remove('expanded');
  } else {
    content.classList.add('show');
    toggle.classList.add('expanded');
    loadHistoryData(area);
  }
}

// Load complete history data
function loadHistoryData(area) {
  let data;
  if (area === '795') data = data795;
  else if (area === '797') data = data797;
  else if (area === '800') data = data800;
  
  // Update statistics
  updateHistoryStats(area, data);
  
  // Load complete history table
  loadHistoryTable(area, data);
}

// Update history statistics
function updateHistoryStats(area, data) {
  const statsDiv = document.getElementById(`stats${area}`);
  const totalRecords = data.length;
  const compliantRecords = data.filter(entry => entry.compliant).length;
  const nonCompliantRecords = totalRecords - compliantRecords;
  const complianceRate = totalRecords > 0 ? ((compliantRecords / totalRecords) * 100).toFixed(1) : 0;
  
  // Get date range
  let dateRange = 'No data';
  if (data.length > 0) {
    const firstDate = new Date(data[0].timestamp).toLocaleDateString();
    const lastDate = new Date(data[data.length - 1].timestamp).toLocaleDateString();
    dateRange = firstDate === lastDate ? firstDate : `${firstDate} - ${lastDate}`;
  }
  
  statsDiv.innerHTML = `
    <div class="history-stat">
      <span class="number">${totalRecords}</span>
      <span class="label">Total Records</span>
    </div>
    <div class="history-stat">
      <span class="number">${complianceRate}%</span>
      <span class="label">Compliance Rate</span>
    </div>
    <div class="history-stat">
      <span class="number">${compliantRecords}</span>
      <span class="label">Compliant</span>
    </div>
    <div class="history-stat">
      <span class="number">${nonCompliantRecords}</span>
      <span class="label">Non-Compliant</span>
    </div>
    <div class="history-stat">
      <span class="number">${dateRange}</span>
      <span class="label">Date Range</span>
    </div>
  `;
}

// Load complete history table
function loadHistoryTable(area, data) {
  const table = document.getElementById(`historyTable${area}`);
  table.innerHTML = '';
  
  // Show all records in reverse chronological order (newest first)
  data.slice().reverse().forEach(entry => {
    const row = table.insertRow();
    row.className = entry.compliant ? '' : 'out';
    
    const cleaningTasks = entry.cleaningTasks && entry.cleaningTasks.length > 0 
      ? entry.cleaningTasks.join(', ') 
      : 'None';
    
    if (area === '795') {
      // Non-sterile area - no pressure column
      row.innerHTML = `
        <td>${entry.timestamp}</td>
        <td>${entry.temp}</td>
        <td>${entry.hum}</td>
        <td>${entry.staff}</td>
        <td>${entry.status}</td>
        <td>${cleaningTasks}</td>
      `;
    } else {
      // Sterile and hazardous areas - include pressure column
      const pressureValue = entry.pressure !== null && entry.pressure !== undefined ? entry.pressure : 'N/A';
      row.innerHTML = `
        <td>${entry.timestamp}</td>
        <td>${entry.temp}</td>
        <td>${entry.hum}</td>
        <td>${pressureValue}</td>
        <td>${entry.staff}</td>
        <td>${entry.status}</td>
        <td>${cleaningTasks}</td>
      `;
    }
  });
}

// Simple credentials
const credentials = {
  "admin": "pharmacy123",
  "pharmacist": "compound456",
  "tech": "sterile789"
};

// USP limits
const limits = {
  795: {tMin: 68, tMax: 77, hMax: 60},
  797: {tMin: 68, tMax: 77, hMax: 60, pressureMin: 0.01, pressureMax: 0.05}, // 0.01-0.05 inches WC positive pressure
  800: {tMin: 68, tMax: 77, hMax: 60, pressureMin: -0.05, pressureMax: -0.01} // 0.01-0.05 inches WC negative pressure
};

// Data storage
let data795 = JSON.parse(localStorage.getItem("data795") || "[]");
let data797 = JSON.parse(localStorage.getItem("data797") || "[]");
let data800 = JSON.parse(localStorage.getItem("data800") || "[]");

// Download file locally
function downloadFile(fileName, content) {
  const blob = new Blob([content], { type: 'text/plain' });
  const url = window.URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = fileName;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  window.URL.revokeObjectURL(url);
}

// Generate PDF report for area data
function generateAreaReport(area, data) {
  const areaNames = {
    '795': 'Non-Sterile Compounding Area (USP <795>)',
    '797': 'Sterile Compounding Area (USP <797>)',
    '800': 'Hazardous Drug Compounding Area (USP <800>)'
  };
  
  const areaColors = {
    '795': '#27ae60',
    '797': '#3498db', 
    '800': '#e67e22'
  };
  
  const today = new Date().toLocaleDateString();
  const user = sessionStorage.getItem("user") || "Unknown";
  
  // Calculate compliance statistics
  const totalRecords = data.length;
  const compliantRecords = data.filter(entry => entry.compliant).length;
  const nonCompliantRecords = totalRecords - compliantRecords;
  const complianceRate = totalRecords > 0 ? ((compliantRecords / totalRecords) * 100).toFixed(1) : 0;
  
  // Get recent temperature and humidity ranges
  const recentData = data.slice(-30);
  const temps = recentData.map(e => e.temp).filter(t => !isNaN(t));
  const hums = recentData.map(e => e.hum).filter(h => !isNaN(h));
  
  const tempRange = temps.length > 0 ? `${Math.min(...temps)}¬∞F - ${Math.max(...temps)}¬∞F` : 'No data';
  const humRange = hums.length > 0 ? `${Math.min(...hums)}% - ${Math.max(...hums)}%` : 'No data';
  
  return `
<!DOCTYPE html>
<html>
<head>
  <title>${areaNames[area]} Compliance Report</title>
  <style>
    body { 
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
      margin: 40px; 
      line-height: 1.6; 
      color: #2c3e50;
    }
    .header { 
      text-align: center; 
      border-bottom: 4px solid ${areaColors[area]}; 
      padding-bottom: 25px; 
      margin-bottom: 35px; 
    }
    .header h1 { 
      color: ${areaColors[area]}; 
      font-weight: 700; 
      margin: 0; 
      font-size: 28px; 
    }
    .header .subtitle {
      font-size: 16px;
      color: #7f8c8d;
      margin-top: 10px;
    }
    .summary { 
      background: #f8f9fa; 
      padding: 15px; 
      border-radius: 8px; 
      margin: 20px 0; 
      border-left: 4px solid ${areaColors[area]}; 
      text-align: center;
    }
    .summary h3 {
      color: ${areaColors[area]};
      margin: 0 0 5px 0;
      font-size: 16px;
    }
    .summary p {
      margin: 0;
      font-size: 14px;
      color: #7f8c8d;
    }
    .stats { 
      display: grid; 
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); 
      gap: 20px; 
      margin: 25px 0; 
    }
    .stat-box { 
      background: white; 
      padding: 20px; 
      border-radius: 10px; 
      text-align: center; 
      border: 2px solid #ecf0f1;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .stat-box h3 { 
      margin: 0; 
      font-size: 24px; 
      color: ${areaColors[area]}; 
      font-weight: 700; 
    }
    .stat-box p {
      margin: 5px 0 0 0;
      color: #7f8c8d;
      font-weight: 600;
    }
    .records-section {
      margin-top: 30px;
    }
    .record-card {
      background: white;
      border: 1px solid #dee2e6;
      border-radius: 8px;
      margin: 15px 0;
      overflow: hidden;
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }
    .record-header {
      background: ${areaColors[area]};
      color: white;
      padding: 15px 20px;
      font-weight: 600;
      font-size: 16px;
    }
    .record-content {
      padding: 20px;
    }
    .record-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin-bottom: 15px;
    }
    .record-field {
      background: #f8f9fa;
      padding: 12px;
      border-radius: 6px;
      border-left: 3px solid ${areaColors[area]};
    }
    .record-field strong {
      display: block;
      color: ${areaColors[area]};
      font-size: 12px;
      text-transform: uppercase;
      margin-bottom: 5px;
    }
    .record-field span {
      font-size: 16px;
      font-weight: 600;
    }
    .status-compliant {
      background: #d4edda;
      color: #155724;
      padding: 8px 15px;
      border-radius: 20px;
      font-weight: 600;
      display: inline-block;
    }
    .status-non-compliant {
      background: #f8d7da;
      color: #721c24;
      padding: 8px 15px;
      border-radius: 20px;
      font-weight: 600;
      display: inline-block;
    }
    .cleaning-tasks {
      background: #fff3cd;
      padding: 12px;
      border-radius: 6px;
      margin-top: 10px;
      border-left: 3px solid #ffc107;
    }
    .cleaning-tasks strong {
      color: #856404;
      font-size: 12px;
      text-transform: uppercase;
      display: block;
      margin-bottom: 5px;
    }
    .no-records {
      text-align: center;
      padding: 40px;
      color: #7f8c8d;
      font-style: italic;
    }
  </style>
</head>
<body>
  <div class="header">
    <h1>üß™ ${areaNames[area]}</h1>
    <div class="subtitle">Environmental Monitoring & Compliance Report</div>
    <p><strong>Generated:</strong> ${today} | <strong>By:</strong> ${user}</p>
  </div>
  
  <div class="summary">
    <h3>üìä Summary</h3>
    <p>Environmental monitoring data for ${areaNames[area]} - USP compliance tracking.</p>
  </div>
  
  <div class="stats">
    <div class="stat-box">
      <h3>${totalRecords}</h3>
      <p>Total Records</p>
    </div>
    <div class="stat-box">
      <h3>${complianceRate}%</h3>
      <p>Compliance Rate</p>
    </div>
    <div class="stat-box">
      <h3>${compliantRecords}</h3>
      <p>Compliant Readings</p>
    </div>
    <div class="stat-box">
      <h3>${nonCompliantRecords}</h3>
      <p>Non-Compliant Readings</p>
    </div>
    <div class="stat-box">
      <h3>${tempRange}</h3>
      <p>Temperature Range (Recent)</p>
    </div>
    <div class="stat-box">
      <h3>${humRange}</h3>
      <p>Humidity Range (Recent)</p>
    </div>
  </div>
  
  <div class="records-section">
    <h3>üìù Detailed Records</h3>
    ${data.length === 0 ? '<div class="no-records">No monitoring records available</div>' : 
      data.slice().reverse().map((entry, index) => `
        <div class="record-card">
          <div class="record-header">
            Record #${data.length - index} - ${entry.timestamp}
          </div>
          <div class="record-content">
            <div class="record-grid">
              <div class="record-field">
                <strong>Temperature</strong>
                <span>${entry.temp}¬∞F</span>
              </div>
              <div class="record-field">
                <strong>Humidity</strong>
                <span>${entry.hum}% RH</span>
              </div>
              <div class="record-field">
                <strong>Recorded By</strong>
                <span>${entry.staff}</span>
              </div>
              <div class="record-field">
                <strong>Compliance Status</strong>
                <span class="${entry.compliant ? 'status-compliant' : 'status-non-compliant'}">
                  ${entry.compliant ? '‚úÖ COMPLIANT' : '‚ùå NON-COMPLIANT'}
                </span>
              </div>
            </div>
            ${entry.cleaningTasks && entry.cleaningTasks.length > 0 ? `
              <div class="cleaning-tasks">
                <strong>üßΩ Cleaning Tasks Completed</strong>
                <div>${entry.cleaningTasks.join(' ‚Ä¢ ')}</div>
              </div>
            ` : ''}
          </div>
        </div>
      `).join('')
    }
  </div>
  
  <div style="margin-top: 40px; padding-top: 20px; border-top: 2px solid #ecf0f1; text-align: center; color: #7f8c8d; font-size: 12px;">
    <p>This report was generated automatically by the Pharmacy Compounding Compliance Log system.</p>
    <p>For questions or concerns regarding compliance, contact your Quality Assurance department.</p>
  </div>
</body>
</html>`;
}

// Get completed cleaning tasks for an area
function getCompletedCleaningTasks(area) {
  const tasks = [];
  const checkboxes = ['surface', 'floor', 'equipment', 'hood'];
  
  checkboxes.forEach(task => {
    const checkbox = document.getElementById(`clean${area}_${task}`);
    if (checkbox && checkbox.checked) {
      let taskName = task.charAt(0).toUpperCase() + task.slice(1) + ' Cleaning';
      tasks.push(taskName);
    }
  });
  
  return tasks;
}

// Clear cleaning checkboxes for an area
function clearCleaningCheckboxes(area) {
  const checkboxes = ['surface', 'floor', 'equipment', 'hood'];
  checkboxes.forEach(task => {
    const checkbox = document.getElementById(`clean${area}_${task}`);
    if (checkbox) checkbox.checked = false;
  });
}

// Handle Enter key press on login form
function handleLoginKeyPress(event) {
  if (event.key === 'Enter') {
    login();
  }
}

// Login function
function login() {
  try {
    const user = document.getElementById("loginUser").value.trim().toLowerCase();
    const pass = document.getElementById("loginPass").value;
    const error = document.getElementById("loginError");
    
    if (credentials[user] && credentials[user] === pass) {
      sessionStorage.setItem("loggedIn", "true");
      sessionStorage.setItem("user", user);
      showApp();
    } else {
      error.style.display = "block";
      error.textContent = "Invalid username or password";
    }
  } catch (e) {
    console.error("Login error:", e);
    alert("Login system error. Please refresh the page and try again.");
  }
}

// Logout function
function logout() {
  sessionStorage.clear();
  document.getElementById("loginScreen").style.display = "block";
  document.getElementById("app").style.display = "none";
}

// Show app
function showApp() {
  document.getElementById("loginScreen").style.display = "none";
  document.getElementById("app").style.display = "block";
}

// Check if logged in
function checkLogin() {
  if (sessionStorage.getItem("loggedIn") === "true") {
    showApp();
  }
}

// Tab switching
function switchTab(tabName) {
  const tabs = document.querySelectorAll('.tab-content');
  tabs.forEach(tab => tab.classList.remove('active'));
  
  const buttons = document.querySelectorAll('.tab-button');
  buttons.forEach(btn => btn.classList.remove('active'));
  
  document.getElementById(tabName).classList.add('active');
  
  const activeBtn = document.querySelector(`.tab-button.${tabName}`);
  if (activeBtn) activeBtn.classList.add('active');
}

// Check compliance
function checkCompliance(area) {
  // This function can be removed or simplified since we no longer show status
  // Keeping it for potential future use or if needed for validation
}

// Record data
function recordData(area) {
  const temp = parseFloat(document.getElementById(`temp${area}`).value);
  const hum = parseFloat(document.getElementById(`hum${area}`).value);
  const staff = document.getElementById(`staff${area}`).value.trim();
  
  if (isNaN(temp) || isNaN(hum) || !staff) {
    alert("Please fill in all fields");
    return;
  }
  
  const limit = limits[area];
  const tempOK = temp >= limit.tMin && temp <= limit.tMax;
  const humOK = hum <= limit.hMax;
  const compliant = tempOK && humOK;
  
  // Get completed cleaning tasks
  const cleaningTasks = getCompletedCleaningTasks(area);
  
  const entry = {
    timestamp: new Date().toLocaleString(),
    temp: temp,
    hum: hum,
    staff: staff,
    status: compliant ? "COMPLIANT" : "NON-COMPLIANT",
    compliant: compliant,
    cleaningTasks: cleaningTasks
  };
  
  // Save data locally
  if (area === '795') {
    data795.push(entry);
    localStorage.setItem("data795", JSON.stringify(data795));
  } else if (area === '797') {
    data797.push(entry);
    localStorage.setItem("data797", JSON.stringify(data797));
  } else if (area === '800') {
    data800.push(entry);
    localStorage.setItem("data800", JSON.stringify(data800));
  }
  
  // Generate PDF report
  const areaName = area === '795' ? 'Non-Sterile' : area === '797' ? 'Sterile' : 'Hazardous';
  const fileName = `${areaName}_USP_${area}_Report_${new Date().toISOString().split('T')[0]}.html`;
  
  let data;
  if (area === '795') data = data795;
  else if (area === '797') data = data797;
  else if (area === '800') data = data800;
  
  const reportContent = generateAreaReport(area, data);
  
  // Download PDF report
  downloadFile(fileName, reportContent);
  
  // Clear form and checkboxes
  document.getElementById(`temp${area}`).value = '';
  document.getElementById(`hum${area}`).value = '';
  document.getElementById(`staff${area}`).value = '';
  clearCleaningCheckboxes(area);
  
  // Update table
  loadData();
  
  // Show result
  const cleaningInfo = cleaningTasks.length > 0 ? `\nCleaning tasks completed: ${cleaningTasks.join(', ')}` : '';
  
  if (!compliant) {
    alert(`‚ö†Ô∏è NON-COMPLIANT READING RECORDED!\n\nRequired: 68-77¬∞F, ‚â§60% RH\nRecorded: ${temp}¬∞F, ${hum}% RH${cleaningInfo}\n\nPDF report downloaded: ${fileName}\n\nCORRECTIVE ACTION REQUIRED`);
  } else {
    alert(`‚úÖ Compliant reading recorded!${cleaningInfo}\n\nPDF report downloaded: ${fileName}`);
  }
}

// Load data into tables
function loadData() {
  // Update history sections if they're currently open
  ['795', '797', '800'].forEach(area => {
    const historyContent = document.getElementById(`history${area}`);
    if (historyContent && historyContent.classList.contains('show')) {
      loadHistoryData(area);
    }
  });
}

// Initialize
document.addEventListener('DOMContentLoaded', function() {
  checkLogin();
});
</script>

</body>
</html>