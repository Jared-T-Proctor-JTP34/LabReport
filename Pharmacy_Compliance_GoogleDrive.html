<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Pharmacy Compounding Compliance Log</title>

<!--
BACKEND GOOGLE DRIVE INTEGRATION:
‚úÖ No user authentication required
‚úÖ Automatic background uploads
‚úÖ Seamless operation

The system now uses a backend service to handle all Google Drive operations.
Users don't need to authenticate or see any Google-related UI.
All reports are automatically saved to Google Drive in the background.
-->

<style>
body { 
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
  font-weight: 600; 
  background: #f4f6f9; 
  margin: 20px; 
}
h1, h2 { 
  color: #2c3e50; 
  font-weight: 700; 
}
section { 
  background: #fff; 
  padding: 20px; 
  margin-bottom: 20px; 
  border-radius: 8px; 
  box-shadow: 0 2px 4px rgba(0,0,0,0.1); 
}
label { 
  display: block; 
  margin-top: 10px; 
  font-weight: 600; 
}
input, select, button { 
  padding: 10px; 
  margin-top: 5px; 
  width: 100%; 
  max-width: 300px; 
  font-family: inherit; 
  font-weight: 500; 
  border-radius: 6px; 
  border: 1px solid #ddd;
}
button { 
  background: #3498db; 
  color: white; 
  border: none; 
  cursor: pointer; 
  font-weight: 600; 
  max-width: none;
}
button:hover { 
  background: #2980b9; 
}
.alert { 
  color: red; 
  font-weight: bold; 
}
table { 
  width: 100%; 
  border-collapse: collapse; 
  margin-top: 15px; 
}
th, td { 
  border: 1px solid #ccc; 
  padding: 10px; 
}
th { 
  background: #ecf0f1; 
  font-weight: 700; 
}
.out { 
  background: #ffe6e6; 
}

/* Google Drive Status */
.drive-status {
  background: #e8f4fd;
  padding: 15px;
  border-radius: 8px;
  margin: 10px 0;
  border-left: 4px solid #4285f4;
}
.drive-status.connected {
  background: #d4edda;
  border-left-color: #28a745;
  color: #155724;
}
.drive-status.error {
  background: #f8d7da;
  border-left-color: #dc3545;
  color: #721c24;
}

/* Tab Styles */
.tab-nav { 
  display: flex; 
  background: #fff; 
  border-radius: 6px 6px 0 0; 
  box-shadow: 0 2px 4px rgba(0,0,0,0.1); 
  margin-top: 20px;
}
.tab-button { 
  flex: 1; 
  padding: 15px 20px; 
  border: none; 
  cursor: pointer; 
  font-size: 14px; 
  font-weight: bold;
  border-right: 1px solid #bdc3c7;
  max-width: none;
  width: auto;
}
.tab-button:last-child { 
  border-right: none; 
}
.tab-button.active { 
  background: #3498db; 
  color: white; 
}
.tab-button:hover:not(.active) { 
  background: #d5dbdb; 
}

.tab-button.non-sterile { 
  background: #2ecc71; 
  color: white; 
}
.tab-button.non-sterile.active { 
  background: #27ae60; 
}

.tab-button.sterile { 
  background: #3498db; 
  color: white; 
}
.tab-button.sterile.active { 
  background: #2980b9; 
}

.tab-button.hazardous { 
  background: #e74c3c; 
  color: white; 
}
.tab-button.hazardous.active { 
  background: #c0392b; 
}

.tab-button.cleaning { 
  background: #9b59b6; 
  color: white; 
}
.tab-button.cleaning.active { 
  background: #8e44ad; 
}

.tab-content { 
  display: none; 
  background: #fff;
  padding: 20px;
  border-radius: 0 0 6px 6px;
  box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}
.tab-content.active { 
  display: block; 
}

.status-indicator {
  padding: 8px;
  margin: 10px 0;
  border-radius: 4px;
  font-weight: 600;
  text-align: center;
}
.status-compliant {
  background: #d4edda;
  color: #155724;
}
.status-non-compliant {
  background: #f8d7da;
  color: #721c24;
}
.status-pending {
  background: #fff3cd;
  color: #856404;
}

/* Custom checkbox styling */
.cleaning-checkbox {
  width: 20px !important;
  height: 20px !important;
  margin-right: 12px !important;
  cursor: pointer;
  accent-color: #3498db;
}

.cleaning-label {
  display: flex;
  align-items: center;
  margin: 2px 0;
  font-size: 14px;
  font-weight: 600;
  cursor: pointer;
  padding: 4px 8px;
  border-radius: 6px;
  transition: background-color 0.2s;
}

.cleaning-label:hover {
  background-color: #f8f9fa;
}

/* History section styling */
.history-section {
  margin-top: 30px;
  border: 1px solid #dee2e6;
  border-radius: 8px;
  overflow: hidden;
}

.history-header {
  background: #f8f9fa;
  padding: 15px 20px;
  cursor: pointer;
  border-bottom: 1px solid #dee2e6;
  display: flex;
  justify-content: space-between;
  align-items: center;
  transition: background-color 0.2s;
}

.history-header:hover {
  background: #e9ecef;
}

.history-header h3 {
  margin: 0;
  font-size: 16px;
  color: #495057;
}

.history-toggle {
  font-size: 18px;
  color: #6c757d;
  transition: transform 0.2s;
}

.history-toggle.expanded {
  transform: rotate(180deg);
}

.history-content {
  display: none;
  padding: 20px;
  background: white;
}

.history-content.show {
  display: block;
}

.history-stats {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
  gap: 15px;
  margin-bottom: 20px;
  padding: 15px;
  background: #f8f9fa;
  border-radius: 6px;
}

.history-stat {
  text-align: center;
}

.history-stat .number {
  font-size: 24px;
  font-weight: 700;
  color: #495057;
  display: block;
}

.history-stat .label {
  font-size: 12px;
  color: #6c757d;
  text-transform: uppercase;
  font-weight: 600;
}
</style>
</head>

<body>

<!-- Login Screen -->
<div id="loginScreen" style="max-width:400px;margin:80px auto;padding:20px;background:#fff;border-radius:8px;box-shadow:0 2px 6px rgba(0,0,0,0.15)">
  <h2>Compliance Log Access</h2>
  <div style="background:#f8f9fa;padding:10px;border-radius:4px;margin:10px 0;font-size:12px;color:#666;">
    <strong>Demo Credentials:</strong><br>
    admin / pharmacy123<br>
    pharmacist / compound456<br>
    tech / sterile789
  </div>
  <label>Username</label>
  <input type="text" id="loginUser" onkeypress="handleLoginKeyPress(event)">
  <label>Password</label>
  <input type="password" id="loginPass" onkeypress="handleLoginKeyPress(event)">
  <button onclick="login()">Login</button>
  <p id="loginError" class="alert" style="display:none">Invalid credentials</p>
</div>

<!-- Main App -->
<div id="app" style="display:none">

<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;padding:15px 0;border-bottom:2px solid #ecf0f1;">
  <h1 style="margin:0;">Pharmacy Compounding Compliance Log</h1>
  <div>
    <button onclick="logout()" style="background:#e74c3c;padding:10px 20px;">Logout</button>
  </div>
</div>

<!-- System Status -->
<div id="systemStatus" class="drive-status">
  <strong>ÔøΩ System Status:</strong> <span id="systemStatusText">Initializing...</span>
  <div id="systemDetails" style="font-size:12px;margin-top:5px;">Connecting to backend services...</div>
  <div style="font-size:11px;margin-top:8px;padding:8px;background:rgba(255,255,255,0.3);border-radius:4px;">
    <strong>üìã Auto-Export:</strong> All compliance reports automatically save to Google Drive in the background
  </div>
</div>

<!-- Tabbed Interface -->
<div class="tab-nav">
  <button class="tab-button non-sterile active" onclick="switchTab('non-sterile')">üß™ Non-Sterile (&lt;795&gt;)</button>
  <button class="tab-button sterile" onclick="switchTab('sterile')">üî¨ Sterile (&lt;797&gt;)</button>
  <button class="tab-button hazardous" onclick="switchTab('hazardous')">‚ö†Ô∏è Hazardous (&lt;800&gt;)</button>
</div>

<!-- Non-Sterile USP <795> Tab -->
<div id="non-sterile" class="tab-content active">
  <h2>üß™ Non-Sterile Compounding Area (USP &lt;795&gt;)</h2>
  <div style="background:#e8f5e8;padding:10px;border-radius:4px;margin:10px 0;font-size:12px;">
    <strong>USP Requirements:</strong> Temperature: 68-77¬∞F | Humidity: ‚â§60% RH
  </div>
  
  <label>Temperature (¬∞F)</label>
  <input type="number" id="temp795" step="0.1">
  
  <label>Humidity (%)</label>
  <input type="number" id="hum795" step="0.1">
  
  <label>Initials</label>
  <input type="text" id="staff795">
  
  <div style="background:#f8f9fa;padding:15px;border-radius:6px;margin:15px 0;border-left:4px solid #27ae60;">
    <h4 style="margin:0 0 10px 0;color:#27ae60;">üßΩ Daily Cleaning Tasks</h4>
    <div style="display:flex;flex-direction:column;">
      <label class="cleaning-label"><input type="checkbox" id="clean795_surface" class="cleaning-checkbox"> Surface Cleaning</label>
      <label class="cleaning-label"><input type="checkbox" id="clean795_floor" class="cleaning-checkbox"> Floor Cleaning</label>
      <label class="cleaning-label"><input type="checkbox" id="clean795_equipment" class="cleaning-checkbox"> Equipment Cleaning</label>
      <label class="cleaning-label"><input type="checkbox" id="clean795_hood" class="cleaning-checkbox"> Hood Cleaning</label>
    </div>
  </div>
  
  <button onclick="recordData('795')" style="background:#27ae60;padding:15px;font-size:16px;">
    ÔøΩ Get Report
  </button>
  
  <!-- History Section -->
  <div class="history-section">
    <div class="history-header" onclick="toggleHistory('795')">
      <h3>üìä Complete History</h3>
      <span class="history-toggle" id="toggle795">‚ñº</span>
    </div>
    <div class="history-content" id="history795">
      <div class="history-stats" id="stats795">
        <!-- Stats will be populated by JavaScript -->
      </div>
      <table style="width:100%;border-collapse:collapse;">
        <thead>
          <tr><th>Date & Time</th><th>Temp (¬∞F)</th><th>Humidity (%)</th><th>Initials</th><th>Status</th><th>Cleaning Tasks</th></tr>
        </thead>
        <tbody id="historyTable795"></tbody>
      </table>
    </div>
  </div>
</div>

<!-- Sterile USP <797> Tab -->
<div id="sterile" class="tab-content">
  <h2>üî¨ Sterile Compounding Area (USP &lt;797&gt;)</h2>
  <div style="background:#e8f4fd;padding:10px;border-radius:4px;margin:10px 0;font-size:12px;">
    <strong>USP Requirements:</strong> Temperature: 68-77¬∞F | Humidity: ‚â§60% RH | Air Pressure: +0.01 to +0.05 inches WC (positive pressure)
  </div>
  
  <label>Temperature (¬∞F)</label>
  <input type="number" id="temp797" step="0.1">
  
  <label>Humidity (%)</label>
  <input type="number" id="hum797" step="0.1">
  
  <label>Air Pressure (inches WC)</label>
  <input type="number" id="pressure797" step="0.001" placeholder="e.g., 0.025">
  
  <label>Initials</label>
  <input type="text" id="staff797">
  
  <div style="background:#f8f9fa;padding:15px;border-radius:6px;margin:15px 0;border-left:4px solid #3498db;">
    <h4 style="margin:0 0 10px 0;color:#3498db;">üßΩ Daily Cleaning Tasks</h4>
    <div style="display:flex;flex-direction:column;">
      <label class="cleaning-label"><input type="checkbox" id="clean797_surface" class="cleaning-checkbox"> Surface Cleaning</label>
      <label class="cleaning-label"><input type="checkbox" id="clean797_floor" class="cleaning-checkbox"> Floor Cleaning</label>
      <label class="cleaning-label"><input type="checkbox" id="clean797_equipment" class="cleaning-checkbox"> Equipment Cleaning</label>
      <label class="cleaning-label"><input type="checkbox" id="clean797_hood" class="cleaning-checkbox"> Hood Cleaning</label>
    </div>
  </div>
  
  <button onclick="recordData('797')" style="background:#3498db;padding:15px;font-size:16px;">
    ÔøΩ Get Report
  </button>
  
  <table style="margin-top:20px;">
    <thead>
      <tr><th>Date & Time</th><th>Temp (¬∞F)</th><th>Humidity (%)</th><th>Pressure (" WC)</th><th></th>Initials</th><th>Status</th></tr>
    </thead>

  
  <!-- History Section -->
  <div class="history-section">
    <div class="history-header" onclick="toggleHistory('797')">
      <h3>üìä Complete History</h3>
      <span class="history-toggle" id="toggle797">‚ñº</span>
    </div>
    <div class="history-content" id="history797">
      <div class="history-stats" id="stats797">
        <!-- Stats will be populated by JavaScript -->
      </div>
      <table style="width:100%;border-collapse:collapse;">
        <thead>
          <tr><th>Date & Time</th><th>Temp (¬∞F)</th><th>Humidity (%)</th><th>Pressure (" WC)</th><th>Initials</th><th>Status</th><th>Cleaning Tasks</th></tr>
        </thead>
        <tbody id="historyTable797"></tbody>
      </table>
    </div>
  </div>
</div>

<!-- Hazardous USP <800> Tab -->
<div id="hazardous" class="tab-content">
  <h2>‚ö†Ô∏è Hazardous Drug Compounding Area (USP &lt;800&gt;)</h2>
  <div style="background:#fdf2e8;padding:10px;border-radius:4px;margin:10px 0;font-size:12px;">
    <strong>USP Requirements:</strong> Temperature: 68-77¬∞F | Humidity: ‚â§60% RH | Air Pressure: -0.01 to -0.05 inches WC (negative pressure)
  </div>
  
  <label>Temperature (¬∞F)</label>
  <input type="number" id="temp800" step="0.1">
  
  <label>Humidity (%)</label>
  <input type="number" id="hum800" step="0.1">
  
  <label>Air Pressure (inches WC)</label>
  <input type="number" id="pressure800" step="0.001" placeholder="e.g., -0.025">
  
  <label>Initials</label>
  <input type="text" id="staff800">
  
  <div style="background:#f8f9fa;padding:15px;border-radius:6px;margin:15px 0;border-left:4px solid #e67e22;">
    <h4 style="margin:0 0 10px 0;color:#e67e22;">üßΩ Daily Cleaning Tasks</h4>
    <div style="display:flex;flex-direction:column;">
      <label class="cleaning-label"><input type="checkbox" id="clean800_surface" class="cleaning-checkbox"> Surface Cleaning</label>
      <label class="cleaning-label"><input type="checkbox" id="clean800_floor" class="cleaning-checkbox"> Floor Cleaning</label>
      <label class="cleaning-label"><input type="checkbox" id="clean800_equipment" class="cleaning-checkbox"> Equipment Cleaning</label>
      <label class="cleaning-label"><input type="checkbox" id="clean800_hood" class="cleaning-checkbox"> Hood Cleaning</label>
    </div>
  </div>
  
  <button onclick="recordData('800')" style="background:#e67e22;padding:15px;font-size:16px;">
    ÔøΩ Get Report
  </button>
  
  <table style="margin-top:20px;">
    <thead>
      <tr><th>Date & Time</th><th>Temp (¬∞F)</th><th>Humidity (%)</th><th>Pressure (" WC)</th><th></th>Initials</th><th>Status</th></tr>
    </thead>

  
  <!-- History Section -->
  <div class="history-section">
    <div class="history-header" onclick="toggleHistory('800')">
      <h3>üìä Complete History</h3>
      <span class="history-toggle" id="toggle800">‚ñº</span>
    </div>
    <div class="history-content" id="history800">
      <div class="history-stats" id="stats800">
        <!-- Stats will be populated by JavaScript -->
      </div>
      <table style="width:100%;border-collapse:collapse;">
        <thead>
          <tr><th>Date & Time</th><th>Temp (¬∞F)</th><th>Humidity (%)</th><th>Pressure (" WC)</th><th>Initials</th><th>Status</th><th>Cleaning Tasks</th></tr>
        </thead>
        <tbody id="historyTable800"></tbody>
      </table>
    </div>
  </div>
</div>

</div>

<!-- Backend Service Integration - No Google Authentication Required -->
<!-- PDF Generation Library -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<script>
// Backend Service Configuration
const BACKEND_URL = 'http://localhost:8001'; // Backend service URL
const TARGET_FOLDER_ID = '1C-5yxY7r0DafqWKrOpq9gtJrOrcCU0Sc';

// System status variables
let backend_available = false;
let system_initialized = false;

// Simple credentials
const credentials = {
  "admin": "pharmacy123",
  "pharmacist": "compound456",
  "tech": "sterile789"
};

// USP limits
const limits = {
  795: {tMin: 68, tMax: 77, hMax: 60},
  797: {tMin: 68, tMax: 77, hMax: 60, pressureMin: 0.01, pressureMax: 0.05}, // 0.01-0.05 inches WC positive pressure
  800: {tMin: 68, tMax: 77, hMax: 60, pressureMin: -0.05, pressureMax: -0.01} // 0.01-0.05 inches WC negative pressure
};

// Data storage
let data795 = JSON.parse(localStorage.getItem("data795") || "[]");
let data797 = JSON.parse(localStorage.getItem("data797") || "[]");
let data800 = JSON.parse(localStorage.getItem("data800") || "[]");

// Check backend service status
async function checkBackendStatus() {
  try {
    const response = await fetch(`${BACKEND_URL}/status`);
    if (response.ok) {
      const status = await response.json();
      backend_available = true;
      updateSystemStatus('connected', 'Backend Service Connected', 'Google Drive integration ready');
      return true;
    } else {
      throw new Error('Backend service not responding');
    }
  } catch (error) {
    backend_available = false;
    updateSystemStatus('warning', 'Backend Service Offline', 'Files will download locally until service is started');
    console.log('Backend service not available:', error.message);
    return false;
  }
}

// Update system status display
function updateSystemStatus(status, text, details) {
  const statusDiv = document.getElementById('systemStatus');
  const statusText = document.getElementById('systemStatusText');
  const statusDetails = document.getElementById('systemDetails');
  
  if (statusDiv && statusText && statusDetails) {
    statusDiv.className = `drive-status ${status}`;
    statusText.textContent = text;
    statusDetails.textContent = details;
  }
}
// History toggle functionality
function toggleHistory(area) {
  const content = document.getElementById(`history${area}`);
  const toggle = document.getElementById(`toggle${area}`);
  
  if (content.classList.contains('show')) {
    content.classList.remove('show');
    toggle.classList.remove('expanded');
  } else {
    content.classList.add('show');
    toggle.classList.add('expanded');
    loadHistoryData(area);
  }
}

// Load complete history data
function loadHistoryData(area) {
  let data;
  if (area === '795') data = data795;
  else if (area === '797') data = data797;
  else if (area === '800') data = data800;
  
  // Update statistics
  updateHistoryStats(area, data);
  
  // Load complete history table
  loadHistoryTable(area, data);
}

// Update history statistics
function updateHistoryStats(area, data) {
  const statsDiv = document.getElementById(`stats${area}`);
  const totalRecords = data.length;
  const compliantRecords = data.filter(entry => entry.compliant).length;
  const nonCompliantRecords = totalRecords - compliantRecords;
  const complianceRate = totalRecords > 0 ? ((compliantRecords / totalRecords) * 100).toFixed(1) : 0;
  
  // Get date range
  let dateRange = 'No data';
  if (data.length > 0) {
    const firstDate = new Date(data[0].timestamp).toLocaleDateString();
    const lastDate = new Date(data[data.length - 1].timestamp).toLocaleDateString();
    dateRange = firstDate === lastDate ? firstDate : `${firstDate} - ${lastDate}`;
  }
  
  statsDiv.innerHTML = `
    <div class="history-stat">
      <span class="number">${totalRecords}</span>
      <span class="label">Total Records</span>
    </div>
    <div class="history-stat">
      <span class="number">${complianceRate}%</span>
      <span class="label">Compliance Rate</span>
    </div>
    <div class="history-stat">
      <span class="number">${compliantRecords}</span>
      <span class="label">Compliant</span>
    </div>
    <div class="history-stat">
      <span class="number">${nonCompliantRecords}</span>
      <span class="label">Non-Compliant</span>
    </div>
    <div class="history-stat">
      <span class="number">${dateRange}</span>
      <span class="label">Date Range</span>
    </div>
  `;
}

// Load complete history table
function loadHistoryTable(area, data) {
  const table = document.getElementById(`historyTable${area}`);
  table.innerHTML = '';
  
  // Show all records in reverse chronological order (newest first)
  data.slice().reverse().forEach(entry => {
    const row = table.insertRow();
    row.className = entry.compliant ? '' : 'out';
    
    const cleaningTasks = entry.cleaningTasks && entry.cleaningTasks.length > 0 
      ? entry.cleaningTasks.join(', ') 
      : 'None';
    
    if (area === '795') {
      // Non-sterile area - no pressure column
      row.innerHTML = `
        <td>${entry.timestamp}</td>
        <td>${entry.temp}</td>
        <td>${entry.hum}</td>
        <td>${entry.staff}</td>
        <td>${entry.status}</td>
        <td>${cleaningTasks}</td>
      `;
    } else {
      // Sterile and hazardous areas - include pressure column
      const pressureValue = entry.pressure !== null && entry.pressure !== undefined ? entry.pressure : 'N/A';
      row.innerHTML = `
        <td>${entry.timestamp}</td>
        <td>${entry.temp}</td>
        <td>${entry.hum}</td>
        <td>${pressureValue}</td>
        <td>${entry.staff}</td>
        <td>${entry.status}</td>
        <td>${cleaningTasks}</td>
      `;
    }
  });
}

// Upload file to backend service
async function uploadToBackend(fileName, content, contentType = 'application/pdf') {
  if (!backend_available) {
    console.log('Backend service not available, downloading locally');
    downloadFile(fileName, content);
    return true;
  }
  
  try {
    // Convert PDF blob to base64 for transmission
    let fileContent = content;
    let encoding = 'text';
    
    if (content instanceof Blob) {
      const arrayBuffer = await content.arrayBuffer();
      const uint8Array = new Uint8Array(arrayBuffer);
      fileContent = btoa(String.fromCharCode.apply(null, uint8Array));
      encoding = 'base64';
    }
    
    const payload = {
      filename: fileName,
      content: fileContent,
      content_type: contentType,
      encoding: encoding
    };
    
    const response = await fetch(`${BACKEND_URL}/upload`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify(payload)
    });
    
    if (response.ok) {
      const result = await response.json();
      console.log('File uploaded successfully:', result);
      return true;
    } else {
      console.error('Upload failed:', response.statusText);
      downloadFile(fileName, content);
      return true;
    }
  } catch (error) {
    console.error('Upload error:', error);
    downloadFile(fileName, content);
    return true;
  }
}
let data795 = JSON.parse(localStorage.getItem("data795") || "[]");
let data797 = JSON.parse(localStorage.getItem("data797") || "[]");
let data800 = JSON.parse(localStorage.getItem("data800") || "[]");

// Initialize Google APIs
function gapiLoaded() {
  if (!GOOGLE_API_KEY) {
    console.log('Google API Key not configured');
    return;
  }
  gapi.load('client', initializeGapiClient);
}

async function initializeGapiClient() {
  try {
    await gapi.client.init({
      apiKey: GOOGLE_API_KEY,
      discoveryDocs: [DISCOVERY_DOC],
    });
    gapi_loaded = true;
    maybeEnableButtons();
  } catch (error) {
    console.error('Failed to initialize Google API client:', error);
    updateDriveStatus('error', 'Google Drive API Error', 'Failed to initialize API client');
  }
}

function gisLoaded() {
  if (!GOOGLE_CLIENT_ID) {
    console.log('Google Client ID not configured');
    return;
  }
  
  try {
    tokenClient = google.accounts.oauth2.initTokenClient({
      client_id: GOOGLE_CLIENT_ID,
      scope: SCOPES,
      callback: (tokenResponse) => {
        if (tokenResponse.error) {
          console.error('Token error:', tokenResponse.error);
          updateDriveStatus('error', 'Authentication Failed', tokenResponse.error);
          return;
        }
        
        access_token = tokenResponse.access_token;
        
        // Save token with expiry (Google tokens typically last 1 hour)
        const expiryTime = new Date().getTime() + (3600 * 1000); // 1 hour from now
        localStorage.setItem('google_drive_token', access_token);
        localStorage.setItem('google_drive_token_expiry', expiryTime.toString());
        
        // Save account hint for future silent auth attempts
        if (tokenResponse.hd) {
          localStorage.setItem('google_account_hint', tokenResponse.hd);
        }
        
        updateDriveStatus('connected', 'Google Drive Connected', 'Ready to upload files automatically');
        document.getElementById('driveAuthBtn').textContent = 'Disconnect Google Drive';
        
        // Set up token refresh
        setupTokenRefresh(expiryTime);
      },
    });
    gis_loaded = true;
    maybeEnableButtons();
  } catch (error) {
    console.error('Failed to initialize Google Identity Services:', error);
    updateDriveStatus('error', 'Google Drive Setup Error', 'Failed to initialize authentication');
  }
}

// Set up automatic token refresh
function setupTokenRefresh(expiryTime) {
  const refreshTime = expiryTime - (5 * 60 * 1000); // Refresh 5 minutes before expiry
  const timeUntilRefresh = refreshTime - new Date().getTime();
  
  if (timeUntilRefresh > 0) {
    setTimeout(() => {
      if (access_token) {
        console.log('Refreshing Google Drive token...');
        // Attempt silent refresh
        tokenClient.requestAccessToken({
          prompt: '',
          hint: localStorage.getItem('google_account_hint') || ''
        });
      }
    }, timeUntilRefresh);
  }
}

function maybeEnableButtons() {
  if (!GOOGLE_CLIENT_ID || !GOOGLE_API_KEY) {
    updateDriveStatus('error', 'Google Drive Not Configured', 'Please set up Google Cloud Console credentials');
    return;
  }
  
  // Check if we're running on HTTPS or localhost
  const isSecure = location.protocol === 'https:' || location.hostname === 'localhost' || location.hostname === '127.0.0.1';
  
  if (!isSecure) {
    updateDriveStatus('warning', 'Google Drive Requires HTTPS', 
      'Google APIs only work on HTTPS or localhost. Files will download locally until deployed to labreporttool.xyz');
    google_apis_available = false;
    return;
  }
  
  if (gapi_loaded && gis_loaded) {
    google_apis_available = true;
    
    // Try to restore previous authentication
    const savedToken = localStorage.getItem('google_drive_token');
    const tokenExpiry = localStorage.getItem('google_drive_token_expiry');
    
    if (savedToken && tokenExpiry && new Date().getTime() < parseInt(tokenExpiry)) {
      // Token is still valid
      access_token = savedToken;
      updateDriveStatus('connected', 'Google Drive Connected', 'Automatically restored from previous session');
      document.getElementById('driveAuthBtn').textContent = 'Disconnect Google Drive';
    } else {
      // Token expired or doesn't exist
      if (savedToken) {
        localStorage.removeItem('google_drive_token');
        localStorage.removeItem('google_drive_token_expiry');
      }
      
      if (auto_authenticate && !authentication_attempted) {
        // Attempt automatic authentication
        updateDriveStatus('info', 'Google Drive Auto-Connecting...', 'Attempting automatic authentication');
        setTimeout(() => {
          if (!access_token) {
            attemptAutoAuthentication();
          }
        }, 1000);
      } else {
        updateDriveStatus('ready', 'Google Drive API Ready', 'Click "Connect Google Drive" to authenticate');
      }
    }
  }
}

// Attempt automatic authentication
function attemptAutoAuthentication() {
  if (authentication_attempted) return;
  authentication_attempted = true;
  
  try {
    // Try silent authentication first
    tokenClient.requestAccessToken({
      prompt: '', // Empty prompt for silent auth
      hint: localStorage.getItem('google_account_hint') || ''
    });
  } catch (error) {
    console.log('Silent authentication failed, user interaction required');
    updateDriveStatus('ready', 'Google Drive Ready', 'Click "Connect Google Drive" to authenticate');
  }
}

// Google Drive Authentication
function toggleGoogleDriveAuth() {
  // Check if we're running on HTTPS or localhost
  const isSecure = location.protocol === 'https:' || location.hostname === 'localhost' || location.hostname === '127.0.0.1';
  
  if (!isSecure) {
    alert('Google Drive authentication requires HTTPS or localhost.\n\nOptions:\n1. Deploy to labreporttool.xyz\n2. Use the local HTTPS server\n3. Files will download locally for now');
    return;
  }
  
  if (!google_apis_available) {
    alert('Google Drive API is still loading or not properly configured. Please wait a moment and try again.');
    return;
  }
  
  if (access_token) {
    // Disconnect
    const confirmDisconnect = confirm('Disconnect from Google Drive?\n\nFiles will download locally instead of uploading to Google Drive.');
    if (confirmDisconnect) {
      google.accounts.oauth2.revoke(access_token, () => {
        access_token = null;
        localStorage.removeItem('google_drive_token');
        localStorage.removeItem('google_drive_token_expiry');
        localStorage.removeItem('google_account_hint');
        updateDriveStatus('ready', 'Google Drive Disconnected', 'Click "Connect Google Drive" to re-authenticate');
        document.getElementById('driveAuthBtn').textContent = 'Connect Google Drive';
      });
    }
  } else {
    // Connect
    if (!gapi_loaded || !gis_loaded) {
      alert('Google Drive API is still loading. Please wait a moment and try again.');
      return;
    }
    
    try {
      updateDriveStatus('info', 'Authenticating...', 'Please complete the Google authentication flow');
      tokenClient.requestAccessToken({prompt: 'consent'});
    } catch (error) {
      console.error('Authentication error:', error);
      alert('Failed to authenticate with Google Drive. Please check your configuration.');
    }
  }
}

// Update Drive Status Display
function updateDriveStatus(status, text, details) {
  const statusDiv = document.getElementById('driveStatus');
  const statusText = document.getElementById('driveStatusText');
  const statusDetails = document.getElementById('driveDetails');
  const authBtn = document.getElementById('driveAuthBtn');
  
  statusDiv.className = `drive-status ${status}`;
  statusText.textContent = text;
  statusDetails.textContent = details;
  
  // Show/hide auth button based on status
  if (status === 'connected') {
    authBtn.style.display = 'none'; // Hide button when connected
    authBtn.textContent = 'Disconnect Google Drive';
  } else if (status === 'ready') {
    authBtn.style.display = 'inline-block'; // Show button when ready to connect
    authBtn.textContent = 'Connect Google Drive';
  } else if (status === 'info' && text.includes('Auto-Connecting')) {
    authBtn.style.display = 'none'; // Hide during auto-connection
  } else {
    authBtn.style.display = 'inline-block'; // Show for errors/warnings
    authBtn.textContent = 'Connect Google Drive';
  }
}

// Upload file to Google Drive
async function uploadToGoogleDrive(fileName, content, mimeType = 'application/pdf') {
  // Check if we're running on HTTPS or localhost
  const isSecure = location.protocol === 'https:' || location.hostname === 'localhost' || location.hostname === '127.0.0.1';
  
  if (!isSecure) {
    console.log('Google Drive requires HTTPS, downloading locally instead');
    downloadFile(fileName, content);
    return true; // Return true so the rest of the flow continues
  }
  
  if (!google_apis_available) {
    console.log('Google Drive API not available, saving locally instead');
    downloadFile(fileName, content);
    return true; // Return true so the rest of the flow continues
  }
  
  if (!access_token) {
    console.log('Not authenticated with Google Drive, downloading locally instead');
    downloadFile(fileName, content);
    return true;
  }

  try {
    const metadata = {
      name: fileName,
      parents: [TARGET_FOLDER_ID]
    };

    const form = new FormData();
    form.append('metadata', new Blob([JSON.stringify(metadata)], {type: 'application/json'}));
    
    // Handle both Blob and string content
    if (content instanceof Blob) {
      form.append('file', content);
    } else {
      form.append('file', new Blob([content], {type: mimeType}));
    }

    const response = await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart', {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${access_token}`
      },
      body: form
    });

    if (response.ok) {
      const result = await response.json();
      console.log('File uploaded successfully:', result);
      return true;
    } else {
      console.error('Upload failed:', response.statusText);
      alert('Upload to Google Drive failed. File will be downloaded locally instead.');
      downloadFile(fileName, content);
      return true;
    }
  } catch (error) {
    console.error('Upload error:', error);
    alert('Upload to Google Drive failed. File will be downloaded locally instead.');
    downloadFile(fileName, content);
    return true;
  }
}

// Fallback: Download file locally
function downloadFile(fileName, content) {
  let blob;
  if (content instanceof Blob) {
    blob = content;
  } else {
    blob = new Blob([content], { type: 'text/plain' });
  }
  
  const url = window.URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = fileName;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  window.URL.revokeObjectURL(url);
}

// Generate PDF report for area data
function generateAreaPDF(area, data) {
  const areaNames = {
    '795': 'Non-Sterile Compounding Area (USP <795>)',
    '797': 'Sterile Compounding Area (USP <797>)',
    '800': 'Hazardous Drug Compounding Area (USP <800>)'
  };
  
  const areaColors = {
    '795': [39, 174, 96],   // Green RGB
    '797': [52, 152, 219],  // Blue RGB  
    '800': [230, 126, 34]   // Orange RGB
  };
  
  const today = new Date().toLocaleDateString();
  const user = sessionStorage.getItem("user") || "Unknown";
  
  // Calculate compliance statistics
  const totalRecords = data.length;
  const compliantRecords = data.filter(entry => entry.compliant).length;
  const nonCompliantRecords = totalRecords - compliantRecords;
  const complianceRate = totalRecords > 0 ? ((compliantRecords / totalRecords) * 100).toFixed(1) : 0;
  
  // Create new PDF document
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();
  
  // Set up colors
  const primaryColor = areaColors[area];
  const textColor = [44, 62, 80];
  const lightGray = [248, 249, 250];
  const darkGray = [108, 117, 125];
  
  // Header
  doc.setFillColor(...primaryColor);
  doc.rect(0, 0, 210, 30, 'F');
  
  doc.setTextColor(255, 255, 255);
  doc.setFontSize(18);
  doc.setFont(undefined, 'bold');
  doc.text('üß™ Pharmacy Compounding Compliance Report', 20, 15);
  
  doc.setFontSize(12);
  doc.setFont(undefined, 'normal');
  doc.text(areaNames[area], 20, 22);
  
  // Reset text color
  doc.setTextColor(...textColor);
  
  // Report info
  let yPos = 45;
  doc.setFontSize(10);
  doc.text(`Generated: ${today}`, 20, yPos);
  doc.text(`By: ${user}`, 120, yPos);
  yPos += 15;
  
  // Summary section
  doc.setFillColor(...lightGray);
  doc.rect(15, yPos, 180, 25, 'F');
  
  doc.setTextColor(...primaryColor);
  doc.setFontSize(14);
  doc.setFont(undefined, 'bold');
  doc.text('üìä Compliance Summary', 20, yPos + 8);
  
  doc.setTextColor(...textColor);
  doc.setFontSize(10);
  doc.setFont(undefined, 'normal');
  doc.text(`Total Records: ${totalRecords}`, 20, yPos + 15);
  doc.text(`Compliance Rate: ${complianceRate}%`, 70, yPos + 15);
  doc.text(`Compliant: ${compliantRecords}`, 130, yPos + 15);
  doc.text(`Non-Compliant: ${nonCompliantRecords}`, 160, yPos + 15);
  
  yPos += 35;
  
  // USP Requirements section
  doc.setTextColor(...primaryColor);
  doc.setFontSize(12);
  doc.setFont(undefined, 'bold');
  doc.text('üìã USP Requirements', 20, yPos);
  
  doc.setTextColor(...textColor);
  doc.setFontSize(10);
  doc.setFont(undefined, 'normal');
  yPos += 8;
  
  doc.text('‚Ä¢ Temperature: 68-77¬∞F', 25, yPos);
  yPos += 5;
  doc.text('‚Ä¢ Humidity: ‚â§60% RH', 25, yPos);
  yPos += 5;
  
  if (area === '797') {
    doc.text('‚Ä¢ Air Pressure: +0.01 to +0.05 inches WC (positive pressure)', 25, yPos);
    yPos += 5;
  } else if (area === '800') {
    doc.text('‚Ä¢ Air Pressure: -0.01 to -0.05 inches WC (negative pressure)', 25, yPos);
    yPos += 5;
  }
  
  yPos += 10;
  
  // Records section
  if (data.length > 0) {
    doc.setTextColor(...primaryColor);
    doc.setFontSize(12);
    doc.setFont(undefined, 'bold');
    doc.text('üìù Monitoring Records', 20, yPos);
    yPos += 10;
    
    // Table headers
    doc.setFillColor(...primaryColor);
    doc.rect(15, yPos, 180, 8, 'F');
    
    doc.setTextColor(255, 255, 255);
    doc.setFontSize(8);
    doc.setFont(undefined, 'bold');
    
    let xPos = 18;
    doc.text('Date & Time', xPos, yPos + 5);
    xPos += 35;
    doc.text('Temp (¬∞F)', xPos, yPos + 5);
    xPos += 20;
    doc.text('Humidity (%)', xPos, yPos + 5);
    xPos += 25;
    
    if (area !== '795') {
      doc.text('Pressure (" WC)', xPos, yPos + 5);
      xPos += 25;
    }
    
    doc.text('Staff', xPos, yPos + 5);
    xPos += 20;
    doc.text('Status', xPos, yPos + 5);
    xPos += 20;
    doc.text('Cleaning Tasks', xPos, yPos + 5);
    
    yPos += 8;
    
    // Table rows
    doc.setTextColor(...textColor);
    doc.setFont(undefined, 'normal');
    
    // Show most recent 15 records to fit on page
    const recentRecords = data.slice(-15).reverse();
    
    recentRecords.forEach((entry, index) => {
      if (yPos > 270) {
        doc.addPage();
        yPos = 20;
      }
      
      // Alternate row colors
      if (index % 2 === 0) {
        doc.setFillColor(250, 250, 250);
        doc.rect(15, yPos, 180, 6, 'F');
      }
      
      // Set text color based on compliance
      if (entry.compliant) {
        doc.setTextColor(...textColor);
      } else {
        doc.setTextColor(220, 53, 69); // Red for non-compliant
      }
      
      xPos = 18;
      doc.setFontSize(7);
      
      // Format timestamp to fit
      const shortTime = new Date(entry.timestamp).toLocaleDateString() + ' ' + 
                       new Date(entry.timestamp).toLocaleTimeString().substring(0, 5);
      doc.text(shortTime, xPos, yPos + 4);
      xPos += 35;
      
      doc.text(entry.temp.toString(), xPos, yPos + 4);
      xPos += 20;
      
      doc.text(entry.hum.toString(), xPos, yPos + 4);
      xPos += 25;
      
      if (area !== '795') {
        const pressureValue = entry.pressure !== null && entry.pressure !== undefined ? 
                             entry.pressure.toString() : 'N/A';
        doc.text(pressureValue, xPos, yPos + 4);
        xPos += 25;
      }
      
      doc.text(entry.staff, xPos, yPos + 4);
      xPos += 20;
      
      doc.text(entry.compliant ? '‚úì' : '‚úó', xPos, yPos + 4);
      xPos += 20;
      
      const cleaningTasks = entry.cleaningTasks && entry.cleaningTasks.length > 0 ? 
                           entry.cleaningTasks.join(', ').substring(0, 20) + '...' : 'None';
      doc.text(cleaningTasks, xPos, yPos + 4);
      
      yPos += 6;
    });
    
    if (data.length > 15) {
      yPos += 5;
      doc.setTextColor(...darkGray);
      doc.setFontSize(8);
      doc.text(`... and ${data.length - 15} more records (showing most recent 15)`, 20, yPos);
    }
  } else {
    doc.setTextColor(...darkGray);
    doc.setFontSize(10);
    doc.text('No monitoring records available', 20, yPos);
  }
  
  // Footer
  doc.setTextColor(...darkGray);
  doc.setFontSize(8);
  doc.text('Generated by Pharmacy Compounding Compliance Log System', 20, 285);
  doc.text(`Report ID: ${Date.now()}`, 150, 285);
  
  // Return PDF as blob
  return doc.output('blob');
}

// Get completed cleaning tasks for an area
function getCompletedCleaningTasks(area) {
  const tasks = [];
  const checkboxes = ['surface', 'floor', 'equipment', 'hood'];
  
  checkboxes.forEach(task => {
    const checkbox = document.getElementById(`clean${area}_${task}`);
    if (checkbox && checkbox.checked) {
      let taskName = task.charAt(0).toUpperCase() + task.slice(1) + ' Cleaning';
      tasks.push(taskName);
    }
  });
  
  return tasks;
}

// Clear cleaning checkboxes for an area
function clearCleaningCheckboxes(area) {
  const checkboxes = ['surface', 'floor', 'equipment', 'hood'];
  checkboxes.forEach(task => {
    const checkbox = document.getElementById(`clean${area}_${task}`);
    if (checkbox) checkbox.checked = false;
  });
}

// Handle Enter key press on login form
function handleLoginKeyPress(event) {
  if (event.key === 'Enter') {
    login();
  }
}

// Login function
function login() {
  try {
    const user = document.getElementById("loginUser").value.trim().toLowerCase();
    const pass = document.getElementById("loginPass").value;
    const error = document.getElementById("loginError");
    
    if (credentials[user] && credentials[user] === pass) {
      sessionStorage.setItem("loggedIn", "true");
      sessionStorage.setItem("user", user);
      showApp();
    } else {
      error.style.display = "block";
      error.textContent = "Invalid username or password";
    }
  } catch (e) {
    console.error("Login error:", e);
    alert("Login system error. Please refresh the page and try again.");
  }
}

// Logout function
function logout() {
  sessionStorage.clear();
  document.getElementById("loginScreen").style.display = "block";
  document.getElementById("app").style.display = "none";
}

// Show app
function showApp() {
  document.getElementById("loginScreen").style.display = "none";
  document.getElementById("app").style.display = "block";
}

// Check if logged in
function checkLogin() {
  if (sessionStorage.getItem("loggedIn") === "true") {
    showApp();
  }
}

// Load data into tables
function loadData() {
  // Update history sections if they're currently open
  ['795', '797', '800'].forEach(area => {
    const historyContent = document.getElementById(`history${area}`);
    if (historyContent && historyContent.classList.contains('show')) {
      loadHistoryData(area);
    }
  });
}

// Tab switching
function switchTab(tabName) {
  const tabs = document.querySelectorAll('.tab-content');
  tabs.forEach(tab => tab.classList.remove('active'));
  
  const buttons = document.querySelectorAll('.tab-button');
  buttons.forEach(btn => btn.classList.remove('active'));
  
  document.getElementById(tabName).classList.add('active');
  
  // Handle different tab types
  if (tabName === 'settings') {
    const activeBtn = document.querySelector('.tab-button.cleaning');
    if (activeBtn) activeBtn.classList.add('active');
    updateSettingsDisplay();
  } else {
    const activeBtn = document.querySelector(`.tab-button.${tabName}`);
    if (activeBtn) activeBtn.classList.add('active');
  }
}

// Check compliance
function checkCompliance(area) {
  // This function can be removed or simplified since we no longer show status
  // Keeping it for potential future use or if needed for validation
}

// Record data
async function recordData(area) {
  const temp = parseFloat(document.getElementById(`temp${area}`).value);
  const hum = parseFloat(document.getElementById(`hum${area}`).value);
  const staff = document.getElementById(`staff${area}`).value.trim();
  
  // Get air pressure for areas that require it (797, 800)
  let pressure = null;
  if (area === '797' || area === '800') {
    const pressureInput = document.getElementById(`pressure${area}`);
    if (pressureInput) {
      pressure = parseFloat(pressureInput.value);
    }
  }
  
  // Validate required fields
  if (isNaN(temp) || isNaN(hum) || !staff) {
    alert("Please fill in all required fields");
    return;
  }
  
  // Validate pressure for areas that require it
  if ((area === '797' || area === '800') && (isNaN(pressure) || pressure === null)) {
    alert("Please enter air pressure reading");
    return;
  }
  
  const limit = limits[area];
  const tempOK = temp >= limit.tMin && temp <= limit.tMax;
  const humOK = hum <= limit.hMax;
  
  // Check pressure compliance for areas that require it
  let pressureOK = true;
  if (area === '797' || area === '800') {
    pressureOK = pressure >= limit.pressureMin && pressure <= limit.pressureMax;
  }
  
  const compliant = tempOK && humOK && pressureOK;
  
  // Get completed cleaning tasks
  const cleaningTasks = getCompletedCleaningTasks(area);
  
  const entry = {
    timestamp: new Date().toLocaleString(),
    temp: temp,
    hum: hum,
    pressure: pressure,
    staff: staff,
    status: compliant ? "COMPLIANT" : "NON-COMPLIANT",
    compliant: compliant,
    cleaningTasks: cleaningTasks
  };
  
  // Save data locally
  if (area === '795') {
    data795.push(entry);
    localStorage.setItem("data795", JSON.stringify(data795));
  } else if (area === '797') {
    data797.push(entry);
    localStorage.setItem("data797", JSON.stringify(data797));
  } else if (area === '800') {
    data800.push(entry);
    localStorage.setItem("data800", JSON.stringify(data800));
  }
  
  // Generate PDF report
  const fileName = `Labreport - ${new Date().toLocaleDateString('en-US', { 
    year: 'numeric', 
    month: '2-digit', 
    day: '2-digit' 
  }).replace(/\//g, '-')}.pdf`;
  
  let data;
  if (area === '795') data = data795;
  else if (area === '797') data = data797;
  else if (area === '800') data = data800;
  
  const reportPDF = generateAreaPDF(area, data);
  
  // Upload to Google Drive
  const uploaded = await uploadToGoogleDrive(fileName, reportPDF, 'application/pdf');
  
  // Clear form and checkboxes
  document.getElementById(`temp${area}`).value = '';
  document.getElementById(`hum${area}`).value = '';
  if (area === '797' || area === '800') {
    document.getElementById(`pressure${area}`).value = '';
  }
  document.getElementById(`staff${area}`).value = '';
  clearCleaningCheckboxes(area);
  
  // Update table
  loadData();
  
  // Show result
  if (uploaded) {
    const isSecure = location.protocol === 'https:' || location.hostname === 'localhost' || location.hostname === '127.0.0.1';
    const uploadMethod = (isSecure && google_apis_available && access_token) ? 'Google Drive' : 'local download';
    const cleaningInfo = cleaningTasks.length > 0 ? `\nCleaning tasks completed: ${cleaningTasks.join(', ')}` : '';
    const pressureInfo = pressure !== null ? `, Pressure: ${pressure}" WC` : '';
    
    if (!compliant) {
      let requirements = '68-77¬∞F, ‚â§60% RH';
      if (area === '797') requirements += ', +0.01 to +0.05" WC';
      if (area === '800') requirements += ', -0.01 to -0.05" WC';
      
      alert(`‚ö†Ô∏è NON-COMPLIANT READING RECORDED!\n\nRequired: ${requirements}\nRecorded: ${temp}¬∞F, ${hum}% RH${pressureInfo}${cleaningInfo}\n\nPDF report saved via: ${uploadMethod}\nFile: ${fileName}\n\nCORRECTIVE ACTION REQUIRED`);
    } else {
      alert(`‚úÖ Compliant reading recorded!\nRecorded: ${temp}¬∞F, ${hum}% RH${pressureInfo}${cleaningInfo}\n\nPDF report saved via: ${uploadMethod}\nFile: ${fileName}`);
    }
  } else {
    alert("‚ùå Failed to save data. Please try again.");
  }
}

// Settings functions
function toggleAutoAuth() {
  const checkbox = document.getElementById('autoAuthCheckbox');
  auto_authenticate = checkbox.checked;
  localStorage.setItem('auto_authenticate', auto_authenticate.toString());
  
  if (auto_authenticate) {
    updateDriveStatus('info', 'Auto-Authentication Enabled', 'Google Drive will connect automatically on next visit');
  } else {
    updateDriveStatus('ready', 'Auto-Authentication Disabled', 'Manual connection required');
  }
}

function toggleDefaultExport() {
  const checkbox = document.getElementById('defaultExportCheckbox');
  const defaultExport = checkbox.checked;
  localStorage.setItem('default_export_drive', defaultExport.toString());
  
  if (defaultExport) {
    alert('‚úÖ Google Drive set as default export location\n\nAll compliance reports will automatically save to your Google Drive folder.');
  } else {
    alert('üìÅ Local download set as default export location\n\nReports will download to your computer instead of Google Drive.');
  }
}

function testGoogleDriveConnection() {
  if (!google_apis_available) {
    alert('‚ùå Google Drive API not available\n\nPlease ensure you are using HTTPS and the APIs have loaded.');
    return;
  }
  
  if (!access_token) {
    alert('‚ùå Not authenticated with Google Drive\n\nPlease connect to Google Drive first.');
    return;
  }
  
  // Test by creating a small test file
  const testContent = `Google Drive Connection Test
Generated: ${new Date().toLocaleString()}
Status: SUCCESS ‚úÖ

This is a test file to verify your Google Drive integration is working correctly.
You can safely delete this file.`;
  
  const testFileName = `Connection-Test-${Date.now()}.txt`;
  
  uploadToGoogleDrive(testFileName, testContent, 'text/plain').then(success => {
    if (success) {
      alert('‚úÖ Google Drive Connection Test Successful!\n\nA test file has been uploaded to your folder.\nYou can safely delete it.');
    } else {
      alert('‚ùå Google Drive Connection Test Failed\n\nPlease check your connection and try again.');
    }
  });
}

function clearGoogleDriveData() {
  const confirm1 = confirm('Clear all Google Drive authentication data?\n\nThis will:\n- Remove saved authentication tokens\n- Require re-authentication\n- Not affect your Google Drive files');
  
  if (confirm1) {
    localStorage.removeItem('google_drive_token');
    localStorage.removeItem('google_drive_token_expiry');
    localStorage.removeItem('google_account_hint');
    
    if (access_token) {
      google.accounts.oauth2.revoke(access_token);
      access_token = null;
    }
    
    updateDriveStatus('ready', 'Authentication Data Cleared', 'Click "Connect Google Drive" to re-authenticate');
    document.getElementById('driveAuthBtn').textContent = 'Connect Google Drive';
    document.getElementById('settingsAuthBtn').textContent = 'Connect Google Drive';
    
    alert('‚úÖ Google Drive authentication data cleared\n\nYou will need to re-authenticate to use Google Drive features.');
  }
}

function exportAllData() {
  const allData = {
    area795: data795,
    area797: data797,
    area800: data800,
    exportDate: new Date().toISOString(),
    totalRecords: data795.length + data797.length + data800.length
  };
  
  const jsonContent = JSON.stringify(allData, null, 2);
  const fileName = `Pharmacy-Compliance-Data-Export-${new Date().toLocaleDateString().replace(/\//g, '-')}.json`;
  
  downloadFile(fileName, jsonContent);
  alert(`‚úÖ Data exported successfully!\n\nFile: ${fileName}\nTotal Records: ${allData.totalRecords}`);
}

function clearAllData() {
  const confirm1 = confirm('‚ö†Ô∏è Clear ALL local compliance data?\n\nThis will permanently delete:\n- All temperature/humidity readings\n- All cleaning task records\n- All historical data\n\nGoogle Drive files will NOT be affected.');
  
  if (confirm1) {
    const confirm2 = confirm('Are you absolutely sure?\n\nThis action cannot be undone!');
    
    if (confirm2) {
      localStorage.removeItem('data795');
      localStorage.removeItem('data797');
      localStorage.removeItem('data800');
      
      data795 = [];
      data797 = [];
      data800 = [];
      
      // Refresh history sections if open
      ['795', '797', '800'].forEach(area => {
        const historyContent = document.getElementById(`history${area}`);
        if (historyContent && historyContent.classList.contains('show')) {
          loadHistoryData(area);
        }
      });
      
      alert('‚úÖ All local data cleared\n\nYour Google Drive files remain safe and unchanged.');
    }
  }
}

// Update settings display
function updateSettingsDisplay() {
  const autoAuthCheckbox = document.getElementById('autoAuthCheckbox');
  const defaultExportCheckbox = document.getElementById('defaultExportCheckbox');
  const authStatusText = document.getElementById('authStatusText');
  const settingsAuthBtn = document.getElementById('settingsAuthBtn');
  
  if (autoAuthCheckbox) {
    autoAuthCheckbox.checked = auto_authenticate;
  }
  
  if (defaultExportCheckbox) {
    const defaultExport = localStorage.getItem('default_export_drive') !== 'false';
    defaultExportCheckbox.checked = defaultExport;
  }
  
  if (authStatusText) {
    if (access_token) {
      authStatusText.textContent = 'Connected ‚úÖ';
      authStatusText.style.color = '#28a745';
    } else {
      authStatusText.textContent = 'Not Connected ‚ùå';
      authStatusText.style.color = '#dc3545';
    }
  }
  
  if (settingsAuthBtn) {
    settingsAuthBtn.textContent = access_token ? 'Disconnect Google Drive' : 'Connect Google Drive';
    settingsAuthBtn.onclick = toggleGoogleDriveAuth;
  }
}



// Initialize
document.addEventListener('DOMContentLoaded', function() {
  checkLogin();
  
  // Load saved settings
  const savedAutoAuth = localStorage.getItem('auto_authenticate');
  if (savedAutoAuth !== null) {
    auto_authenticate = savedAutoAuth === 'true';
  }
  
  // Initialize Google Drive status
  if (!GOOGLE_CLIENT_ID || !GOOGLE_API_KEY) {
    updateDriveStatus('error', 'Google Drive Not Configured', 
      'To enable Google Drive uploads, you need to:\n' +
      '1. Create a Google Cloud Console project\n' +
      '2. Enable the Google Drive API\n' +
      '3. Create OAuth2 credentials\n' +
      '4. Add your Client ID and API Key to this file\n' +
      'Files will download locally until configured.'
    );
  }
  
  // Load Google APIs safely
  setTimeout(() => {
    try {
      if (typeof gapi !== 'undefined' && GOOGLE_API_KEY) {
        gapiLoaded();
      }
      if (typeof google !== 'undefined' && GOOGLE_CLIENT_ID) {
        gisLoaded();
      }
    } catch (error) {
      console.error('Error loading Google APIs:', error);
    }
  }, 1000);
});

// Load Google APIs when they become available
window.gapiLoaded = gapiLoaded;
window.gisLoaded = gisLoaded;
</script>

</body>
</html>