<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Google Drive Connectivity Test</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 800px;
            margin: 40px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .test-container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .status {
            padding: 15px;
            margin: 10px 0;
            border-radius: 5px;
            font-weight: bold;
        }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        .warning { background: #fff3cd; color: #856404; }
        .info { background: #d1ecf1; color: #0c5460; }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background: #0056b3; }
        .test-result {
            margin: 10px 0;
            padding: 10px;
            border-left: 4px solid #007bff;
            background: #f8f9fa;
        }
        pre {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            overflow-x: auto;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>üîç Google Drive Troubleshooting Tool</h1>
        <p>This tool will help diagnose why Google Drive isn't working in your application.</p>
        
        <div class="status error">
            <strong>‚ö†Ô∏è Current Issue:</strong> Google Drive integration not working
        </div>
        
        <div id="configStatus" class="status info">
            <strong>Configuration Status:</strong> Checking...
        </div>
        
        <div class="test-result">
            <h3>Current Configuration:</h3>
            <pre id="configDetails">Loading...</pre>
        </div>
        
        <button onclick="testGoogleAPIs()">üîç Test API Loading</button>
        <button onclick="testAuthentication()">üîê Test Authentication</button>
        <button onclick="testFolderAccess()">üìÅ Test Folder Access</button>
        <button onclick="runFullDiagnostic()">üö® Run Full Diagnostic</button>
        <button onclick="testFromCurrentDomain()">üåê Test Current Domain</button>
        
        <div id="testResults"></div>
        
        <div class="test-result">
            <h3>üìã Setup Checklist:</h3>
            <div id="checklist">
                <div id="check1">‚è≥ Google Client ID configured</div>
                <div id="check2">‚è≥ Google API Key configured</div>
                <div id="check3">‚è≥ Google APIs loading</div>
                <div id="check4">‚è≥ Domain authorized</div>
                <div id="check5">‚è≥ Authentication working</div>
            </div>
        </div>
        
        <div class="status warning">
            <strong>‚ö†Ô∏è Important:</strong> Make sure you have your Google API Key ready to add to the main application!
        </div>
    </div>

    <!-- Google APIs -->
    <script src="https://apis.google.com/js/api.js"></script>
    <script src="https://accounts.google.com/gsi/client"></script>

    <script>
        // Configuration from your main application
        const GOOGLE_CLIENT_ID = '465131191592-kkd73c4d57upufd13njhoue4f4p1ggo2.apps.googleusercontent.com';
        const GOOGLE_API_KEY = 'AIzaSyCL9IVXR7NdT3Iif7Do5YTgVD-l_GCpzYk'; // Your API Key
        const TARGET_FOLDER_ID = '1k_LobI2ggS0rs83VevymeA0D-RHOTYSD';
        const DISCOVERY_DOC = 'https://www.googleapis.com/discovery/v1/apis/drive/v3/rest';
        const SCOPES = 'https://www.googleapis.com/auth/drive.file';

        let gapi_loaded = false;
        let gis_loaded = false;
        let tokenClient;
        let access_token = null;

        // Initialize on page load
        window.onload = function() {
            checkConfiguration();
            setTimeout(initializeAPIs, 1000);
        };

        function checkConfiguration() {
            const configDiv = document.getElementById('configStatus');
            const detailsDiv = document.getElementById('configDetails');
            
            let status = 'success';
            let message = 'Configuration looks good!';
            
            if (!GOOGLE_CLIENT_ID) {
                status = 'error';
                message = 'Google Client ID is missing!';
            } else if (!GOOGLE_API_KEY) {
                status = 'warning';
                message = 'Google API Key is missing - this is the main issue!';
            }
            
            configDiv.className = `status ${status}`;
            configDiv.innerHTML = `<strong>Configuration Status:</strong> ${message}`;
            
            detailsDiv.textContent = `
Client ID: ${GOOGLE_CLIENT_ID || 'NOT SET'}
API Key: ${GOOGLE_API_KEY || 'NOT SET'}
Target Folder: ${TARGET_FOLDER_ID}
Current Domain: ${window.location.origin}
            `.trim();
            
            updateChecklist('check1', GOOGLE_CLIENT_ID ? '‚úÖ' : '‚ùå', 'Google Client ID configured');
            updateChecklist('check2', GOOGLE_API_KEY ? '‚úÖ' : '‚ùå', 'Google API Key configured');
        }

        function updateChecklist(id, icon, text) {
            document.getElementById(id).innerHTML = `${icon} ${text}`;
        }

        function addTestResult(title, status, details) {
            const resultsDiv = document.getElementById('testResults');
            const statusClass = status === 'success' ? 'success' : status === 'error' ? 'error' : 'warning';
            
            resultsDiv.innerHTML += `
                <div class="status ${statusClass}">
                    <strong>${title}:</strong> ${details}
                </div>
            `;
        }

        function initializeAPIs() {
            try {
                if (typeof gapi !== 'undefined') {
                    gapi.load('client', initializeGapiClient);
                    updateChecklist('check3', '‚úÖ', 'Google APIs loading');
                } else {
                    updateChecklist('check3', '‚ùå', 'Google APIs failed to load');
                }
                
                if (typeof google !== 'undefined' && GOOGLE_CLIENT_ID) {
                    initializeGisClient();
                }
            } catch (error) {
                addTestResult('API Initialization', 'error', error.message);
            }
        }

        async function initializeGapiClient() {
            if (!GOOGLE_API_KEY) {
                addTestResult('GAPI Client', 'error', 'Cannot initialize without API Key');
                return;
            }
            
            try {
                await gapi.client.init({
                    apiKey: GOOGLE_API_KEY,
                    discoveryDocs: [DISCOVERY_DOC],
                });
                gapi_loaded = true;
                addTestResult('GAPI Client', 'success', 'Google API client initialized successfully');
            } catch (error) {
                addTestResult('GAPI Client', 'error', `Failed to initialize: ${error.message}`);
            }
        }

        function initializeGisClient() {
            try {
                tokenClient = google.accounts.oauth2.initTokenClient({
                    client_id: GOOGLE_CLIENT_ID,
                    scope: SCOPES,
                    callback: (tokenResponse) => {
                        if (tokenResponse.error) {
                            addTestResult('Authentication', 'error', tokenResponse.error);
                            updateChecklist('check5', '‚ùå', 'Authentication working');
                            return;
                        }
                        access_token = tokenResponse.access_token;
                        addTestResult('Authentication', 'success', 'Successfully authenticated with Google Drive');
                        updateChecklist('check5', '‚úÖ', 'Authentication working');
                    },
                });
                gis_loaded = true;
                addTestResult('GIS Client', 'success', 'Google Identity Services initialized');
                updateChecklist('check4', '‚úÖ', 'Domain authorized (client loaded)');
            } catch (error) {
                addTestResult('GIS Client', 'error', `Failed to initialize: ${error.message}`);
                updateChecklist('check4', '‚ùå', 'Domain authorization failed');
            }
        }

        function testGoogleAPIs() {
            addTestResult('API Loading Test', 'info', 'Testing Google APIs...');
            
            const tests = [
                { name: 'GAPI Available', result: typeof gapi !== 'undefined' },
                { name: 'Google Identity Available', result: typeof google !== 'undefined' },
                { name: 'GAPI Client Loaded', result: gapi_loaded },
                { name: 'GIS Client Loaded', result: gis_loaded },
                { name: 'Client ID Set', result: !!GOOGLE_CLIENT_ID },
                { name: 'API Key Set', result: !!GOOGLE_API_KEY }
            ];
            
            tests.forEach(test => {
                const status = test.result ? 'success' : 'error';
                const icon = test.result ? '‚úÖ' : '‚ùå';
                addTestResult(test.name, status, `${icon} ${test.result ? 'OK' : 'FAILED'}`);
            });
        }

        function testAuthentication() {
            if (!gis_loaded) {
                addTestResult('Authentication Test', 'error', 'Google Identity Services not loaded');
                return;
            }
            
            if (!GOOGLE_API_KEY) {
                addTestResult('Authentication Test', 'error', 'Cannot test without API Key');
                return;
            }
            
            addTestResult('Authentication Test', 'info', 'Starting authentication flow...');
            
            try {
                tokenClient.requestAccessToken({ prompt: 'consent' });
            } catch (error) {
                addTestResult('Authentication Test', 'error', `Authentication failed: ${error.message}`);
            }
        }

        async function testFolderAccess() {
            if (!access_token) {
                addTestResult('Folder Access Test', 'error', 'Please authenticate first');
                return;
            }
            
            addTestResult('Folder Access Test', 'info', 'Testing folder access...');
            
            try {
                const response = await fetch(`https://www.googleapis.com/drive/v3/files/${TARGET_FOLDER_ID}`, {
                    headers: {
                        'Authorization': `Bearer ${access_token}`
                    }
                });
                
                if (response.ok) {
                    const folderInfo = await response.json();
                    addTestResult('Folder Access Test', 'success', `‚úÖ Folder accessible: "${folderInfo.name}"`);
                } else {
                    addTestResult('Folder Access Test', 'error', `‚ùå Folder access failed: ${response.status} ${response.statusText}`);
                }
            } catch (error) {
                addTestResult('Folder Access Test', 'error', `‚ùå Error accessing folder: ${error.message}`);
            }
        }
    </script>

    <script>
        // Additional diagnostic functions
        function runFullDiagnostic() {
            addTestResult('üö® Full Diagnostic', 'info', 'Running comprehensive Google Drive diagnostic...');
            
            // Clear previous results
            document.getElementById('testResults').innerHTML = '';
            
            // Test 1: Configuration
            addTestResult('1Ô∏è‚É£ Configuration Check', 'info', 'Checking credentials...');
            setTimeout(() => {
                const clientIdOK = !!GOOGLE_CLIENT_ID;
                const apiKeyOK = !!GOOGLE_API_KEY;
                const folderIdOK = !!TARGET_FOLDER_ID;
                
                addTestResult('Client ID', clientIdOK ? 'success' : 'error', 
                    clientIdOK ? '‚úÖ Configured' : '‚ùå Missing');
                addTestResult('API Key', apiKeyOK ? 'success' : 'error', 
                    apiKeyOK ? '‚úÖ Configured' : '‚ùå Missing');
                addTestResult('Folder ID', folderIdOK ? 'success' : 'error', 
                    folderIdOK ? '‚úÖ Configured' : '‚ùå Missing');
            }, 100);
            
            // Test 2: Domain Check
            setTimeout(() => {
                addTestResult('2Ô∏è‚É£ Domain Check', 'info', 'Checking current domain...');
                const currentDomain = window.location.origin;
                const isLocalhost = currentDomain.includes('localhost') || currentDomain.includes('127.0.0.1');
                const isGitHub = currentDomain.includes('github.io');
                const isCustomDomain = currentDomain.includes('labreporttool.xyz');
                
                addTestResult('Current Domain', 'info', currentDomain);
                
                if (isLocalhost) {
                    addTestResult('Domain Issue', 'error', '‚ùå localhost not supported by Google OAuth2');
                } else if (isGitHub) {
                    addTestResult('Domain Status', 'warning', '‚ö†Ô∏è GitHub Pages - needs authorization');
                } else if (isCustomDomain) {
                    addTestResult('Domain Status', 'success', '‚úÖ Custom domain detected');
                } else {
                    addTestResult('Domain Status', 'warning', '‚ö†Ô∏è Unknown domain - may need authorization');
                }
            }, 500);
            
            // Test 3: API Loading
            setTimeout(() => {
                addTestResult('3Ô∏è‚É£ API Loading', 'info', 'Testing Google APIs...');
                const gapiLoaded = typeof gapi !== 'undefined';
                const googleLoaded = typeof google !== 'undefined';
                
                addTestResult('GAPI Library', gapiLoaded ? 'success' : 'error', 
                    gapiLoaded ? '‚úÖ Loaded' : '‚ùå Failed to load');
                addTestResult('Google Identity', googleLoaded ? 'success' : 'error', 
                    googleLoaded ? '‚úÖ Loaded' : '‚ùå Failed to load');
                
                if (!gapiLoaded || !googleLoaded) {
                    addTestResult('API Loading Issue', 'error', 
                        '‚ùå Google APIs failed to load. Check internet connection and domain restrictions.');
                }
            }, 1000);
            
            // Test 4: Initialization
            setTimeout(() => {
                addTestResult('4Ô∏è‚É£ Initialization', 'info', 'Testing API initialization...');
                addTestResult('GAPI Client', gapi_loaded ? 'success' : 'error', 
                    gapi_loaded ? '‚úÖ Initialized' : '‚ùå Failed to initialize');
                addTestResult('GIS Client', gis_loaded ? 'success' : 'error', 
                    gis_loaded ? '‚úÖ Initialized' : '‚ùå Failed to initialize');
            }, 1500);
            
            // Test 5: Common Issues
            setTimeout(() => {
                addTestResult('5Ô∏è‚É£ Common Issues Check', 'info', 'Checking for common problems...');
                
                // Check for CORS issues
                if (window.location.protocol === 'file:') {
                    addTestResult('CORS Issue', 'error', '‚ùå Cannot run from file:// protocol');
                }
                
                // Check for HTTPS
                if (window.location.protocol !== 'https:' && !window.location.hostname.includes('localhost')) {
                    addTestResult('HTTPS Issue', 'error', '‚ùå Google OAuth2 requires HTTPS');
                }
                
                // Check API key format
                if (GOOGLE_API_KEY && !GOOGLE_API_KEY.startsWith('AIza')) {
                    addTestResult('API Key Format', 'error', '‚ùå API Key format looks incorrect');
                }
                
                // Check Client ID format
                if (GOOGLE_CLIENT_ID && !GOOGLE_CLIENT_ID.includes('.apps.googleusercontent.com')) {
                    addTestResult('Client ID Format', 'error', '‚ùå Client ID format looks incorrect');
                }
            }, 2000);
            
            // Final recommendations
            setTimeout(() => {
                addTestResult('6Ô∏è‚É£ Recommendations', 'info', 'Generating recommendations...');
                
                let recommendations = [];
                
                if (!GOOGLE_API_KEY) {
                    recommendations.push('‚ùå Add Google API Key to the application');
                }
                
                if (window.location.origin.includes('localhost')) {
                    recommendations.push('‚ùå Deploy to a real domain (localhost not supported)');
                }
                
                if (!gapi_loaded || !gis_loaded) {
                    recommendations.push('‚ùå Check Google Cloud Console API restrictions');
                    recommendations.push('‚ùå Verify domain is authorized in OAuth2 settings');
                }
                
                if (recommendations.length === 0) {
                    addTestResult('Status', 'success', '‚úÖ Configuration looks good! Try the authentication test.');
                } else {
                    recommendations.forEach((rec, index) => {
                        addTestResult(`Fix ${index + 1}`, 'error', rec);
                    });
                }
            }, 2500);
        }

        function testFromCurrentDomain() {
            addTestResult('üåê Domain Test', 'info', `Testing from: ${window.location.origin}`);
            
            // Check if we're on the right domain
            const currentDomain = window.location.origin;
            
            if (currentDomain.includes('localhost') || currentDomain.includes('127.0.0.1')) {
                addTestResult('Domain Issue', 'error', 
                    '‚ùå localhost is not supported by Google OAuth2. You need to test from a real domain.');
                addTestResult('Solution', 'info', 
                    'üí° Deploy to GitHub Pages or your custom domain to test Google Drive integration.');
                return;
            }
            
            if (currentDomain.includes('github.io')) {
                addTestResult('GitHub Pages', 'warning', 
                    '‚ö†Ô∏è Testing from GitHub Pages. Make sure this domain is authorized in Google Cloud Console.');
            }
            
            if (currentDomain.includes('labreporttool.xyz')) {
                addTestResult('Custom Domain', 'success', 
                    '‚úÖ Testing from custom domain. This should work if properly configured.');
            }
            
            // Test API loading from current domain
            setTimeout(() => {
                if (typeof gapi !== 'undefined' && typeof google !== 'undefined') {
                    addTestResult('APIs from Domain', 'success', 
                        '‚úÖ Google APIs loaded successfully from this domain');
                } else {
                    addTestResult('APIs from Domain', 'error', 
                        '‚ùå Google APIs failed to load from this domain');
                }
            }, 1000);
        }
    </script>
</body>
</html>